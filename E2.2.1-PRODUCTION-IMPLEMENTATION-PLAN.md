# E2.2.1 PRODUCTION-READY IMPLEMENTATION PLAN - NO STUBS ALLOWED

**Date**: 2025-09-15
**Effort**: E2.2.1 - CLI Commands (Build & Push)
**Status**: RE-IMPLEMENTATION REQUIRED
**Reason**: R320 VIOLATIONS - Previous implementation contained stubs

## üî¥üî¥üî¥ CRITICAL REQUIREMENTS - ZERO TOLERANCE üî¥üî¥üî¥

### ABSOLUTE REQUIREMENTS - VIOLATION = IMMEDIATE FAILURE

1. **NO STUB IMPLEMENTATIONS** (R320)
   - ‚ùå NO "TODO" comments in implementation code
   - ‚ùå NO "placeholder" returns
   - ‚ùå NO "not implemented" errors
   - ‚ùå NO simulated/fake functionality
   - ‚úÖ ONLY complete, working, production-ready code

2. **FULL FUNCTIONALITY REQUIRED**
   - ‚úÖ Build command MUST create real OCI images
   - ‚úÖ Images MUST be stored locally for push to retrieve
   - ‚úÖ Push command MUST load actual built images
   - ‚úÖ Push MUST send real manifests and layers to registry
   - ‚úÖ Authentication MUST work with environment variables
   - ‚úÖ Progress tracking MUST reflect actual operation progress

3. **PRODUCTION VALIDATION**
   - Code MUST be tested with actual Gitea registry
   - MUST successfully push a real image
   - MUST handle authentication properly
   - MUST report real progress

## Implementation Requirements

### 1. Image Storage System

**Location**: `/tmp/idpbuilder-images/` or `~/.idpbuilder/images/`

**Requirements**:
- Build command saves images in OCI layout format
- Images indexed by tag for retrieval
- Support for multiple images

**Implementation**:
```go
// pkg/storage/image_store.go
type ImageStore interface {
    Save(tag string, image v1.Image) error
    Load(tag string) (v1.Image, error)
    List() ([]string, error)
    Delete(tag string) error
}
```

### 2. Build Command Enhancement

**File**: `pkg/cmd/build.go`

**Requirements**:
- After building image, MUST save to image store
- MUST NOT just create image in memory and discard
- MUST report where image was saved

**Key Code**:
```go
// After image creation
store := storage.NewLocalImageStore()
if err := store.Save(buildTag, img); err != nil {
    return fmt.Errorf("failed to save image: %w", err)
}
fmt.Printf("Image saved to local store: %s\n", buildTag)
```

### 3. Push Command - COMPLETE REWRITE

**File**: `pkg/gitea/client.go`

**REMOVE ENTIRELY**:
```go
// DELETE THIS ENTIRE FUNCTION
func (c *Client) getImageContentForReference(imageRef string) (io.Reader, error) {
    // ALL OF THIS PLACEHOLDER CODE MUST GO
}
```

**REPLACE WITH**:
```go
func (c *Client) getImageContentForReference(imageRef string) (v1.Image, error) {
    store := storage.NewLocalImageStore()

    // Load actual image from store
    img, err := store.Load(imageRef)
    if err != nil {
        return nil, fmt.Errorf("image not found in local store: %w", err)
    }

    return img, nil
}
```

### 4. Registry Push Implementation

**Requirements**:
- Use go-containerregistry's remote.Write
- Send actual image layers
- Handle authentication properly
- Report real progress based on layer uploads

**Implementation**:
```go
func (c *Client) Push(imageRef string, progressChan chan<- PushProgress) error {
    // Load real image
    img, err := c.getImageContentForReference(imageRef)
    if err != nil {
        return err
    }

    // Parse destination
    ref, err := name.ParseReference(fmt.Sprintf("%s/%s", c.config.URL, imageRef))
    if err != nil {
        return err
    }

    // Setup auth
    auth := &authn.Basic{
        Username: c.config.Username,
        Password: c.config.Token,
    }

    // Real progress tracking
    layers, _ := img.Layers()
    totalLayers := len(layers)

    // Push with real progress
    for i, layer := range layers {
        // Push layer
        // Report real progress
        progressChan <- PushProgress{
            CurrentLayer: i + 1,
            TotalLayers:  totalLayers,
            Percentage:   (i + 1) * 100 / totalLayers,
        }
    }

    // Push manifest
    return remote.Write(ref, img, remote.WithAuth(auth))
}
```

### 5. CLI Authentication Support

**File**: `pkg/cmd/push.go`

**Requirements**:
- Add --username and --token flags to push command
- Authentication priority: CLI flags > env vars > config
- Clear error messages if auth fails

**Implementation**:
```go
var (
    pushUsername string
    pushToken    string
)

func init() {
    PushCmd.Flags().StringVar(&pushUsername, "username", "", "Registry username")
    PushCmd.Flags().StringVar(&pushToken, "token", "", "Registry token or password")
}

func getCredentials() (string, string) {
    // Priority 1: CLI flags
    if pushUsername != "" && pushToken != "" {
        return pushUsername, pushToken
    }

    // Priority 2: Environment variables
    username := os.Getenv("GITEA_USERNAME")
    token := os.Getenv("GITEA_TOKEN")
    if token == "" {
        token = os.Getenv("GITEA_PASSWORD")
    }

    // Priority 3: Override individual missing values
    if pushUsername != "" {
        username = pushUsername
    }
    if pushToken != "" {
        token = pushToken
    }

    return username, token
}
```

## Testing Requirements

### Manual Testing Protocol

1. **Build Test**:
   ```bash
   export ENABLE_IMAGE_BUILDER=true
   ./idpbuilder build --context ./test-app --tag myapp:v1.0.0
   # MUST see: "Image saved to local store: myapp:v1.0.0"
   ```

2. **Verify Image Stored**:
   ```bash
   ls -la /tmp/idpbuilder-images/
   # MUST see image file(s)
   ```

3. **Push Test with Environment Variables**:
   ```bash
   export GITEA_USERNAME=giteaAdmin
   export GITEA_TOKEN=<actual-token>
   ./idpbuilder push --registry https://gitea.cnoe.localtest.me:8443 --insecure giteaAdmin/myapp:v1.0.0
   # MUST see real progress percentages
   # MUST complete successfully
   ```

4. **Push Test with CLI Flags**:
   ```bash
   # Unset env vars to test CLI flags
   unset GITEA_USERNAME GITEA_TOKEN
   ./idpbuilder push --username giteaAdmin --token <actual-token> \
     --registry https://gitea.cnoe.localtest.me:8443 --insecure giteaAdmin/myapp:v1.0.0
   # MUST authenticate using CLI flags
   # MUST complete successfully
   ```

5. **Push Test with Mixed Sources**:
   ```bash
   # Test priority: CLI flag overrides env var
   export GITEA_USERNAME=wronguser
   ./idpbuilder push --username giteaAdmin --token <actual-token> \
     --registry https://gitea.cnoe.localtest.me:8443 --insecure giteaAdmin/myapp:v1.0.0
   # MUST use giteaAdmin from CLI flag, not wronguser from env
   ```

4. **Verify in Registry**:
   ```bash
   curl -u giteaAdmin:<token> https://gitea.cnoe.localtest.me:8443/v2/giteaAdmin/myapp/tags/list
   # MUST see the pushed tag
   ```

## Code Review Requirements

### R320 Compliance Check (MANDATORY)

Code Reviewer MUST run:
```bash
# Check for any stubs
grep -r "TODO\|placeholder\|stub\|not.*implemented\|simulate" pkg/

# Check for panic placeholders
grep -r "panic.*unimplemented\|panic.*TODO" pkg/

# Check for NotImplementedError patterns
grep -r "errors.New.*TODO\|fmt.Errorf.*not.*implemented" pkg/

# ANY matches = IMMEDIATE FAILURE
```

### Functional Testing (MANDATORY)

Code Reviewer MUST:
1. Actually build an image with the tool
2. Verify image is saved locally
3. Actually push the image to a registry
4. Verify push succeeds with real data
5. Check registry to confirm image exists

## Success Criteria

- ‚úÖ NO grep matches for stub patterns
- ‚úÖ Build command saves real images locally
- ‚úÖ Push command loads real images from storage
- ‚úÖ Push sends actual OCI manifests and layers
- ‚úÖ Authentication works with environment variables
- ‚úÖ Progress tracking shows real upload progress
- ‚úÖ Successfully pushes image to Gitea registry
- ‚úÖ Image accessible from registry after push

## Failure Conditions

- ‚ùå ANY "TODO" in implementation code
- ‚ùå ANY placeholder returns
- ‚ùå ANY simulated functionality
- ‚ùå Build doesn't save images
- ‚ùå Push doesn't load real images
- ‚ùå Push fails with real registry
- ‚ùå Progress is fake/simulated

## Timeline

- Implementation: 4 hours
- Testing: 2 hours
- Code Review: 2 hours
- Total: 8 hours

**NO SHORTCUTS. NO STUBS. PRODUCTION CODE ONLY.**