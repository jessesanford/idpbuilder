# Orchestrator - INTEGRATION_FEEDBACK_REVIEW State Rules

## üõëüõëüõë R322 MANDATORY STOP BEFORE STATE TRANSITIONS üõëüõëüõë

**SUPREME LAW - VIOLATION = -100% IMMEDIATE FAILURE**

### YOU MUST STOP AFTER:
1. ‚úÖ Completing all TODOs for this state
2. ‚úÖ Updating orchestrator-state.json with new state
3. ‚úÖ Committing and pushing the state file  
4. ‚úÖ Providing work summary

### YOU MUST NOT:
- ‚ùå Continue to the next state automatically
- ‚ùå Start work for the new state
- ‚ùå Spawn agents for the new state
- ‚ùå Assume permission to continue

### STOP PROTOCOL:
```markdown
## üõë STATE TRANSITION CHECKPOINT: CURRENT_STATE ‚Üí NEXT_STATE

### ‚úÖ Current State Work Completed:
- [List completed work]

### üìä Current Status:
- Current State: CURRENT_STATE
- Next State: NEXT_STATE
- TODOs Completed: X/Y
- State Files: Updated and committed ‚úÖ

### ‚è∏Ô∏è STOPPED - Awaiting User Continuation
Ready to transition to NEXT_STATE. Please use /continue-orchestrating.
```

**STOP MEANS STOP - Exit and wait for /continue-orchestrating**

---


## üî¥üî¥üî¥ R290 ENFORCEMENT: READ THESE RULES FIRST! üî¥üî¥üî¥

**SUPREME LAW #3 (R290): STATE RULES MUST BE READ BEFORE STATE ACTIONS**

## üî¥üî¥üî¥ STOP! STATE RULE READING IS ABSOLUTELY FIRST! üî¥üî¥üî¥

**YOU HAVE ENTERED INTEGRATION_FEEDBACK_REVIEW STATE - YOU MUST READ AND ACKNOWLEDGE ALL STATE RULES BEFORE DOING ANY STATE WORK!**

## üî¥üî¥üî¥ R290 VERIFICATION REQUIREMENT üî¥üî¥üî¥

**R290 ENFORCEMENT: CREATE VERIFICATION MARKER AFTER READING**

After reading and acknowledging all state rules, you MUST create a verification marker:

```bash
# MANDATORY: Create verification marker after reading rules
touch .state_rules_read_orchestrator_INTEGRATION_FEEDBACK_REVIEW
echo "$(date +%s) - Rules read and acknowledged for INTEGRATION_FEEDBACK_REVIEW" > .state_rules_read_orchestrator_INTEGRATION_FEEDBACK_REVIEW
```

**FAILURE TO CREATE MARKER = AUTOMATIC -100% PENALTY**

The system will check for this marker. No marker = Immediate failure.

### ‚ùå DO NOT DO ANY INTEGRATION FEEDBACK WORK UNTIL RULES ARE READ:
- ‚ùå Parse integration reports
- ‚ùå Identify failed efforts
- ‚ùå Create fix request metadata
- ‚ùå Update state files
- ‚ùå Continue to next state
- ‚ùå Think about what to do in this state

### ‚úÖ YOU MUST IMMEDIATELY:

## üî¥üî¥üî¥ MANDATORY STATE RULE READING AND ACKNOWLEDGMENT üî¥üî¥üî¥

### ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è YOU MUST READ EACH RULE FILE LISTED IN PRIMARY DIRECTIVES. **I AM WATCHING YOUR TOOL CALLS FOR READ OPERATIONS** *YOU WILL FAIL* IF YOU DO NOT MAKE A READ FILE CALL FOR EACH RULE FILE IN PRIMARY DIRECTIVES!!! ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

**AFTER READING, YOU MUST ACKNOWLEDGE ALL THE STATE RULES AND STATE THAT YOU WILL ABIDE BY THEM ONE AT A TIME GIVING THE RULE NUMBER AND DESCRIPTION.**

### PRIMARY DIRECTIVES - MANDATORY READING:

### üõë RULE R322 - Mandatory Stop Before State Transitions
**Source:** $CLAUDE_PROJECT_DIR/rule-library/R322-mandatory-stop-before-state-transitions.md
**Criticality:** üî¥üî¥üî¥ SUPREME LAW - Violation = -100% FAILURE

After completing state work and committing state file:
1. STOP IMMEDIATELY
2. Do NOT continue to next state
3. Do NOT start new work
4. Exit and wait for user
---

**USE THESE EXACT READ COMMANDS (IN THIS ORDER):**
1. Read: $CLAUDE_PROJECT_DIR/rule-library/R234-mandatory-state-traversal-supreme-law.md
2. Read: $CLAUDE_PROJECT_DIR/rule-library/R006-orchestrator-never-writes-code.md
3. Read: $CLAUDE_PROJECT_DIR/rule-library/R290-state-rule-reading-verification-supreme-law.md
4. Read: $CLAUDE_PROJECT_DIR/rule-library/R291-integration-demo-requirement.md
5. Read: $CLAUDE_PROJECT_DIR/rule-library/R300-comprehensive-fix-management-protocol.md
6. Read: $CLAUDE_PROJECT_DIR/rule-library/R293-integration-report-distribution-protocol.md
7. Read: $CLAUDE_PROJECT_DIR/rule-library/R294-fix-plan-archival-protocol.md
8. Read: $CLAUDE_PROJECT_DIR/rule-library/R238-integration-report-evaluation.md
9. Read: $CLAUDE_PROJECT_DIR/rule-library/R239-fix-plan-distribution.md
10. Read: $CLAUDE_PROJECT_DIR/rule-library/R206-state-machine-transition-validation.md

**WE ARE WATCHING EACH READ TOOL CALL**

### ‚ùå ANTI-PATTERNS THAT WILL CAUSE FAILURE:

1. **Fake Acknowledgment Without Reading**:
   ```
   ‚ùå WRONG: "I acknowledge R234, R208, R290..."
   (No Read tool calls detected = AUTOMATIC FAILURE)
   ```

2. **Bulk Acknowledgment**:
   ```
   ‚ùå WRONG: "I acknowledge all INTEGRATION_FEEDBACK_REVIEW rules"
   (YOU Must READ AND ACKNOWLEDGE EACH rule individually)
   ```

3. **Silent Reading**:
   ```
   ‚ùå WRONG: [Reads rules but doesn't acknowledge]
   "Now I've read the rules, let me start work..."
   (MUST explicitly acknowledge EACH rule)
   ```

4. **Reading From Memory**:
   ```
   ‚ùå WRONG: "I know R238 requires parsing integration reports..."
   (Must READ from file, not recall from memory)
   ```

5. **Skipping Rules in PRIMARY DIRECTIVES**:
   ```
   ‚ùå WRONG: Reading only some rules from the list
   (ALL rules in PRIMARY DIRECTIVES are MANDATORY)
   ```

### ‚úÖ CORRECT PATTERN FOR INTEGRATION_FEEDBACK_REVIEW:
```
1. READ: $CLAUDE_PROJECT_DIR/rule-library/R234-mandatory-state-traversal-supreme-law.md
2. "I acknowledge R234 - Mandatory State Traversal: [Brief description]"
3. READ: $CLAUDE_PROJECT_DIR/rule-library/R006-orchestrator-never-writes-code.md  
4. "I acknowledge R006 - Orchestrator Never Writes Code: [Brief description]"
[Continue for EVERY rule in PRIMARY DIRECTIVES...]
5. Create verification marker
6. "Ready to execute INTEGRATION_FEEDBACK_REVIEW work"
```

### üö® NO WORK UNTIL ACKNOWLEDGMENT COMPLETE üö®
**You may NOT begin ANY INTEGRATION_FEEDBACK_REVIEW work until:**
1. ‚úÖ ALL rules in PRIMARY DIRECTIVES have been READ
2. ‚úÖ ALL rules have been individually ACKNOWLEDGED
3. ‚úÖ Verification marker has been CREATED
4. ‚úÖ You have stated readiness to execute INTEGRATION_FEEDBACK_REVIEW work

### üö® FAILURE TO READ STATE RULES FIRST = IMMEDIATE EXIT üö®
**If you do ANY INTEGRATION_FEEDBACK_REVIEW work before reading and acknowledging rules:**
- **STOP ALL WORK IMMEDIATELY**
- **EXIT WITH FAILURE STATUS**
- **YOU HAVE VIOLATED STATE COMPLIANCE**

**After reading ALL rules, acknowledge them:**
‚ñ° I have read R234 - Mandatory State Traversal (SUPREME LAW #1)
‚ñ° I have read R006 - Orchestrator Never Writes Code
‚ñ° I have read R290 - State Rule Reading and Verification (SUPREME LAW #3)
‚ñ° I have read R291 - Integration Demo Requirement (demo must pass)
‚ñ° I have read R300 - Comprehensive Fix Management Protocol
‚ñ° I have read R293 - Integration Report Distribution Protocol
‚ñ° I have read R294 - Fix Plan Archival Protocol
‚ñ° I have read R238 - Integration Report Evaluation Protocol
‚ñ° I have read R239 - Fix Plan Distribution Protocol
‚ñ° I have read R206 - State Machine Transition Validation

**CRITICAL**: You must have made 10 actual Read tool calls. Count them!

---

## üî¥üî¥üî¥ SUPREME DIRECTIVE: ANALYZE AND FIX INTEGRATION FAILURES üî¥üî¥üî¥

**YOU MUST PARSE INTEGRATION FAILURES AND INITIATE FIX CYCLES!**

## State Overview

In INTEGRATION_FEEDBACK_REVIEW, you analyze the integration report to identify which efforts failed and what fixes are needed.

**üö® CRITICAL (R291): Integration is NOT complete until demo passes!**
**üö® CRITICAL (R300): ALL fixes MUST be made in effort branches, NEVER in integration branch!**

## Required Actions

### 1. Parse Integration Report for Failed Efforts
```bash
PHASE=$(yq '.current_phase' orchestrator-state.json)
WAVE=$(yq '.current_wave' orchestrator-state.json)
REPORT_FILE="efforts/phase${PHASE}/wave${WAVE}/integration-workspace/INTEGRATION_REPORT.md"

echo "üìã Parsing integration report: $REPORT_FILE"

# Extract failed branches and issues
FAILED_BRANCHES=()
ISSUES_BY_BRANCH=()

# Parse the Failed Branches section
while IFS= read -r line; do
    if [[ "$line" =~ ^-[[:space:]]+(.+):[[:space:]]+(.+) ]]; then
        BRANCH="${BASH_REMATCH[1]}"
        ISSUE="${BASH_REMATCH[2]}"
        FAILED_BRANCHES+=("$BRANCH")
        ISSUES_BY_BRANCH+=("$BRANCH:$ISSUE")
    fi
done < <(sed -n '/## Failed Branches/,/## /p' "$REPORT_FILE" | grep "^-")

echo "Found ${#FAILED_BRANCHES[@]} failed branches"
```

### 2. Identify Efforts Needing Fixes
```bash
# Map branches to efforts
EFFORTS_NEEDING_FIXES=()
for branch in "${FAILED_BRANCHES[@]}"; do
    # Extract effort name from branch (e.g., wave1-effort1 from phase1-wave1-effort1)
    EFFORT=$(echo "$branch" | sed "s/phase${PHASE}-wave${WAVE}-//")
    EFFORTS_NEEDING_FIXES+=("$EFFORT")
    
    # Record in state file
    yq eval ".integration_feedback.wave${WAVE}.efforts_needing_fixes += [\"$EFFORT\"]" -i orchestrator-state.json
done

# Check if we have build dependency issues
if grep -q "BLOCKED_BY_DEPENDENCIES" "$REPORT_FILE"; then
    echo "üö® Build blocked by missing dependencies - need system-level fixes"
    
    # Extract missing dependencies
    MISSING_DEPS=$(grep -A5 "Missing Dependencies:" "$REPORT_FILE" | grep "^-" | sed 's/^- //')
    
    # Record in state file
    yq eval ".integration_feedback.wave${WAVE}.missing_dependencies = \"$MISSING_DEPS\"" -i orchestrator-state.json
    yq eval ".integration_feedback.wave${WAVE}.requires_system_fixes = true" -i orchestrator-state.json
fi
```

### 3. Distribute Integration Report and Archive Old Plans (R293 & R294)
```bash
# üö® MANDATORY (R293): Distribute INTEGRATION-REPORT.md to all affected efforts
echo "üìã Distributing integration report per R293..."
INTEGRATION_REPORT="efforts/phase${PHASE}/wave${WAVE}/integration-workspace/INTEGRATION_REPORT.md"

if [[ -f "$INTEGRATION_REPORT" ]]; then
    for effort in "${EFFORTS_NEEDING_FIXES[@]}"; do
        EFFORT_DIR="efforts/phase${PHASE}/wave${WAVE}/${effort}"
        
        # Archive old plans first (R294)
        echo "üì¶ Archiving old fix plans in $EFFORT_DIR per R294..."
        if [[ -d "$EFFORT_DIR" ]]; then
            cd "$EFFORT_DIR"
            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            
            # Archive any existing fix plans
            [[ -f "SPLIT-PLAN.md" ]] && mv SPLIT-PLAN.md "SPLIT-PLAN-COMPLETED-${TIMESTAMP}.md"
            [[ -f "CODE-REVIEW-REPORT.md" ]] && mv CODE-REVIEW-REPORT.md "CODE-REVIEW-REPORT-COMPLETED-${TIMESTAMP}.md"
            [[ -f "INTEGRATION-REPORT.md" ]] && mv INTEGRATION-REPORT.md "INTEGRATION-REPORT-COMPLETED-${TIMESTAMP}.md"
            
            cd - > /dev/null
            
            # Now copy the new integration report
            cp "$INTEGRATION_REPORT" "$EFFORT_DIR/INTEGRATION-REPORT.md"
            echo "‚úÖ Distributed INTEGRATION-REPORT.md to $EFFORT_DIR"
        else
            echo "‚ö†Ô∏è Warning: Effort directory $EFFORT_DIR does not exist"
        fi
    done
else
    echo "‚ùå CRITICAL: Integration report not found at $INTEGRATION_REPORT"
    exit 1
fi
```

### 4. Create Fix Request Metadata
```bash
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
FIX_REQUEST_FILE="efforts/phase${PHASE}/wave${WAVE}/FIX_REQUEST_${TIMESTAMP}.yaml"

cat > "$FIX_REQUEST_FILE" << EOF
fix_request:
  timestamp: "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
  phase: $PHASE
  wave: $WAVE
  integration_report: "$REPORT_FILE"
  failed_efforts:
EOF

for i in "${!EFFORTS_NEEDING_FIXES[@]}"; do
    EFFORT="${EFFORTS_NEEDING_FIXES[$i]}"
    ISSUE="${ISSUES_BY_BRANCH[$i]#*:}"
    cat >> "$FIX_REQUEST_FILE" << EOF
    - effort: "$EFFORT"
      issue: "$ISSUE"
      branch: "phase${PHASE}-wave${WAVE}-${EFFORT}"
      working_directory: "efforts/phase${PHASE}/wave${WAVE}/${EFFORT}"
EOF
done

if [ "${#EFFORTS_NEEDING_FIXES[@]}" -eq 0 ]; then
    echo "‚ö†Ô∏è No specific efforts identified but integration failed"
    echo "Possible system-level issue requiring investigation"
    UPDATE_STATE="ERROR_RECOVERY"
else
    echo "‚úÖ Fix request metadata created"
    UPDATE_STATE="SPAWN_CODE_REVIEWER_FIX_PLAN"
fi
```

### 5. Update State File
```bash
# Update orchestrator state
yq eval ".current_state = \"$UPDATE_STATE\"" -i orchestrator-state.json
yq eval ".integration_feedback.wave${WAVE}.fix_request_file = \"$FIX_REQUEST_FILE\"" -i orchestrator-state.json
yq eval ".integration_feedback.wave${WAVE}.review_timestamp = \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"" -i orchestrator-state.json
yq eval ".state_transition_history += [{\"from\": \"INTEGRATION_FEEDBACK_REVIEW\", \"to\": \"$UPDATE_STATE\", \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"reason\": \"Identified ${#EFFORTS_NEEDING_FIXES[@]} efforts needing fixes\"}]" -i orchestrator-state.json

# Commit changes
git add orchestrator-state.json "$FIX_REQUEST_FILE"
git commit -m "feedback: Identified integration issues for wave ${WAVE} - ${#EFFORTS_NEEDING_FIXES[@]} efforts need fixes"
git push
```

## Valid Transitions

1. **FIX PATH**: `INTEGRATION_FEEDBACK_REVIEW` ‚Üí `SPAWN_CODE_REVIEWER_FIX_PLAN`
   - When: Failed efforts identified, fix plans needed
   
2. **ERROR PATH**: `INTEGRATION_FEEDBACK_REVIEW` ‚Üí `ERROR_RECOVERY`
   - When: No specific efforts identified or system-level issues

## Grading Criteria

- ‚úÖ **+25%**: Correctly parse integration report
- ‚úÖ **+25%**: Identify all failed efforts
- ‚úÖ **+25%**: Create fix request metadata
- ‚úÖ **+25%**: Update state file with feedback details

## Common Violations

- ‚ùå **-100%**: Not reading integration report
- ‚ùå **-50%**: Missing failed efforts
- ‚ùå **-30%**: Not creating fix request metadata
- ‚ùå **-30%**: Not recording in state file

## Integration Report Format Expected

```markdown
## Integration Report
Integration Status: FAILED
Build Status: BLOCKED_BY_DEPENDENCIES
Test Status: NOT_RUN
Demo Status: FAILED  # R291: Must be PASSING for integration to complete

## Failed Branches
- phase1-wave1-effort1: Missing dependency libgpgme
- phase1-wave1-effort2: Build error in authentication module
- phase1-wave1-effort3: Merge conflict in shared config

## Demo Failures (R291 Violations)
- Build failed: Cannot compile due to missing dependencies
- Tests failed: 5 test suites failing
- Demo script error: demo-features.sh exits with code 1

## Missing Dependencies
- libgpgme-dev
- libbtrfs-dev

## Fix Instructions (R300 Compliance)
ALL fixes must be made in the following effort branches:
- feature/effort1: Add libgpgme dependency
- feature/effort2: Fix authentication module compilation
- feature/effort3: Resolve config conflicts
```

## Related Rules

- R291: Integration Demo Requirement (demo must pass before complete)
- R300: Comprehensive Fix Management Protocol
- R293: Integration Report Distribution Protocol (BLOCKING)
- R294: Fix Plan Archival Protocol (BLOCKING)
- R295: SW Engineer Spawn Clarity Protocol (SUPREME)
- R238: Integration Report Evaluation Protocol
- R239: Fix Plan Distribution Protocol
- R260: Integration Agent Core Requirements
- R206: State Machine Transition Validation

## üî¥üî¥üî¥ MANDATORY MEASUREMENT RULE - R304 üî¥üî¥üî¥

**ABSOLUTE REQUIREMENTS:**
- ‚úÖ MUST use `$CLAUDE_PROJECT_DIR/tools/line-counter.sh` for ALL line counting
- ‚ùå NEVER use `wc -l` or any manual counting method
- ‚ùå NEVER count lines any other way - this is a -100% automatic failure
- ‚úÖ MUST specify both -b (base branch) and -c (current branch) parameters
- ‚úÖ Base branch MUST be phase integration branch (NOT "main")

**Failure to use the line counter tool = AUTOMATIC -100% GRADE**

## R322 VIOLATION DETECTION

If you find yourself:
- Starting work for a new state without /continue-orchestrating
- Transitioning without stopping after state file commit
- Continuing after completing state work

**STOP IMMEDIATELY - You are violating R322!**
