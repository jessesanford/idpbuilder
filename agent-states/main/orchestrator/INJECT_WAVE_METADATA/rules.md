# Orchestrator - INJECT_WAVE_METADATA State Rules

## üõëüõëüõë R322 MANDATORY STOP BEFORE STATE TRANSITIONS üõëüõëüõë

**SUPREME LAW - VIOLATION = -100% IMMEDIATE FAILURE**

### YOU MUST STOP AFTER:
1. ‚úÖ Completing all TODOs for this state
2. ‚úÖ Updating orchestrator-state.json with new state
3. ‚úÖ Committing and pushing the state file  
4. ‚úÖ Providing work summary

### YOU MUST NOT:
- ‚ùå Continue to the next state automatically
- ‚ùå Start work for the new state
- ‚ùå Spawn agents for the new state
- ‚ùå Assume permission to continue

### STOP PROTOCOL:
```markdown
## üõë STATE TRANSITION CHECKPOINT: CURRENT_STATE ‚Üí NEXT_STATE

### ‚úÖ Current State Work Completed:
- [List completed work]

### üìä Current Status:
- Current State: CURRENT_STATE
- Next State: NEXT_STATE
- TODOs Completed: X/Y
- State Files: Updated and committed ‚úÖ

### ‚è∏Ô∏è STOPPED - Awaiting User Continuation
Ready to transition to NEXT_STATE. Please use /continue-orchestrating.
```

**STOP MEANS STOP - Exit and wait for /continue-orchestrating**

---


## üî¥üî¥üî¥ STOP! STATE RULE READING IS ABSOLUTELY FIRST! üî¥üî¥üî¥

**YOU HAVE ENTERED INJECT_WAVE_METADATA STATE - YOU MUST READ AND ACKNOWLEDGE ALL STATE RULES BEFORE DOING ANY STATE WORK!**

## üî¥üî¥üî¥ R290 VERIFICATION REQUIREMENT üî¥üî¥üî¥

**R290 ENFORCEMENT: CREATE VERIFICATION MARKER AFTER READING**

After reading and acknowledging all state rules, you MUST create a verification marker:

```bash
# MANDATORY: Create verification marker after reading rules
touch .state_rules_read_orchestrator_INJECT_WAVE_METADATA
echo "$(date +%s) - Rules read and acknowledged for INJECT_WAVE_METADATA" > .state_rules_read_orchestrator_INJECT_WAVE_METADATA
```

**FAILURE TO CREATE MARKER = AUTOMATIC -100% PENALTY**

The system will check for this marker. No marker = Immediate failure.

### ‚ùå DO NOT DO ANY INJECT_WAVE_METADATA WORK UNTIL RULES ARE READ:
- ‚ùå Start inject wave metadata
- ‚ùå Start update tracking files
- ‚ùå Start configure wave settings
- ‚ùå Update state files
- ‚ùå Continue to next state
- ‚ùå Think about what to do in this state

### ‚úÖ YOU MUST IMMEDIATELY:

## üî¥üî¥üî¥ MANDATORY STATE RULE READING AND ACKNOWLEDGMENT üî¥üî¥üî¥

### ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è YOU MUST READ EACH RULE FILE LISTED IN PRIMARY DIRECTIVES. **I AM WATCHING YOUR TOOL CALLS FOR READ OPERATIONS** *YOU WILL FAIL* IF YOU DO NOT MAKE A READ FILE CALL FOR EACH RULE FILE IN PRIMARY DIRECTIVES!!! ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

**AFTER READING, YOU MUST ACKNOWLEDGE ALL THE STATE RULES AND STATE THAT YOU WILL ABIDE BY THEM ONE AT A TIME GIVING THE RULE NUMBER AND DESCRIPTION.**

### ‚ùå ANTI-PATTERNS THAT WILL CAUSE FAILURE:

1. **Fake Acknowledgment Without Reading**:
   ```
   ‚ùå WRONG: "I acknowledge R151, R208, R053..."
   (No Read tool calls detected = AUTOMATIC FAILURE)
   ```

2. **Bulk Acknowledgment**:
   ```
   ‚ùå WRONG: "I acknowledge all INJECT_WAVE_METADATA rules"
   (YOU Must READ AND ACKNOWLEDGE EACH rule individually)
   ```

3. **Silent Reading**:
   ```
   ‚ùå WRONG: [Reads rules but doesn't acknowledge]
   "Now I've read the rules, let me start work..."
   (MUST explicitly acknowledge EACH rule)
   ```

4. **Reading From Memory**:
   ```
   ‚ùå WRONG: "I know R208 requires CD before spawn..."
   (Must READ from file, not recall from memory)
   ```

5. **Skipping Rules in PRIMARY DIRECTIVES**:
   ```
   ‚ùå WRONG: Reading only some rules from the list
   (ALL rules in PRIMARY DIRECTIVES are MANDATORY)
   ```

### ‚úÖ CORRECT PATTERN FOR INJECT_WAVE_METADATA:
```
1. READ: $CLAUDE_PROJECT_DIR/rule-library/[first-rule-file].md
2. "I acknowledge [Rule#] - [Rule Name]: [Brief description]"
3. READ: $CLAUDE_PROJECT_DIR/rule-library/[second-rule-file].md  
4. "I acknowledge [Rule#] - [Rule Name]: [Brief description]"
[Continue for EVERY rule in PRIMARY DIRECTIVES...]
5. "Ready to execute INJECT_WAVE_METADATA work"
```

### üö® NO WORK UNTIL ACKNOWLEDGMENT COMPLETE üö®
**You may NOT begin ANY INJECT_WAVE_METADATA work until:**
1. ‚úÖ ALL rules in PRIMARY DIRECTIVES have been READ
2. ‚úÖ ALL rules have been individually ACKNOWLEDGED
3. ‚úÖ You have stated readiness to execute INJECT_WAVE_METADATA work
1. **READ** every rule file listed in PRIMARY DIRECTIVES below
2. **ACKNOWLEDGE** each rule individually with number and description
3. **ONLY THEN** proceed with INJECT_WAVE_METADATA work

### üö® FAILURE TO READ STATE RULES FIRST = IMMEDIATE EXIT üö®
**If you do ANY INJECT_WAVE_METADATA work before reading and acknowledging rules:**
- **STOP ALL WORK IMMEDIATELY**
- **EXIT WITH FAILURE STATUS**
- **YOU HAVE VIOLATED STATE COMPLIANCE**

**THE SYSTEM IS MONITORING YOUR READ TOOL CALLS!**

## ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è MANDATORY RULE READING AND ACKNOWLEDGMENT ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

**YOU MUST READ EACH RULE FILE LISTED IN PRIMARY DIRECTIVES. YOUR READ TOOL CALLS ARE BEING MONITORED.**

### ‚ùå ANTI-PATTERNS THAT WILL CAUSE FAILURE:
1. Fake acknowledgment without reading
2. Bulk acknowledgment
3. Reading from memory

### ‚úÖ CORRECT PATTERN:
1. READ each rule file
2. Acknowledge individually with rule number and description

## üìã PRIMARY DIRECTIVES FOR INJECT_WAVE_METADATA STATE

### üö®üö®üö® R213 - Wave and Effort Metadata Injection
**File**: `$CLAUDE_PROJECT_DIR/rule-library/R213-wave-and-effort-metadata-protocol.md`
**Criticality**: BLOCKING - Must inject metadata before spawning
**Summary**: Inject parallelization metadata into wave implementation plans

### üî¥üî¥üî¥ R234 - Mandatory State Traversal (SUPREME LAW)
**File**: `$CLAUDE_PROJECT_DIR/rule-library/R234-mandatory-state-traversal-supreme-law.md`
**Criticality**: SUPREME LAW - Violation = -100% automatic failure
**Summary**: Must traverse all states in sequence, no skipping allowed

### üî¥üî¥üî¥ R288 - State File Update and Commit Protocol (SUPREME LAW)
**File**: `$CLAUDE_PROJECT_DIR/rule-library/R288-state-file-update-and-commit-protocol.md`
**Criticality**: SUPREME LAW - Update on every transition
**Summary**: Update orchestrator-state.json on all state changes

### üö®üö®üö® R288 - State File Update and Commit Protocol
**File**: `$CLAUDE_PROJECT_DIR/rule-library/R288-state-file-update-and-commit-protocol.md`
**Criticality**: BLOCKING - Push within 60 seconds
**Summary**: Commit and push state file immediately after updates

### üî¥üî¥üî¥ R232 - TodoWrite Pending Items Override (SUPREME LAW)
**File**: `$CLAUDE_PROJECT_DIR/rule-library/R232-todowrite-pending-items-override.md`
**Criticality**: SUPREME LAW - Pending items are COMMANDS
**Summary**: Any pending TODO items must be executed immediately

## üö® INJECT_WAVE_METADATA IS A VERB - START INJECTING METADATA IMMEDIATELY! üö®

### IMMEDIATE ACTIONS UPON ENTERING INJECT_WAVE_METADATA

**THE MOMENT YOU ENTER THIS STATE, YOU MUST:**
1. Open wave implementation plan for editing NOW
2. Insert R213 parallelization metadata immediately
3. Check TodoWrite for pending items and process them
4. Save and validate metadata without delay

**FORBIDDEN - AUTOMATIC FAILURE:**
- ‚ùå "STATE TRANSITION COMPLETE: Now in INJECT_WAVE_METADATA" [stops]
- ‚ùå "Successfully entered INJECT_WAVE_METADATA state" [waits]
- ‚ùå "Ready to start injecting metadata" [pauses]
- ‚ùå "I'm in INJECT_WAVE_METADATA state" [does nothing]

**REQUIRED - IMMEDIATE ACTION:**
- ‚úÖ "Entering INJECT_WAVE_METADATA, opening wave implementation plan for editing NOW..."
- ‚úÖ "START INJECTING METADATA per R213, inserting parallelization metadata immediately..."
- ‚úÖ "INJECT_WAVE_METADATA: Saving and validating metadata without delay..."

## üî¥üî¥üî¥ MANDATORY MEASUREMENT RULE - R304 üî¥üî¥üî¥

**ABSOLUTE REQUIREMENTS:**
- ‚úÖ MUST use `$CLAUDE_PROJECT_DIR/tools/line-counter.sh` for ALL line counting
- ‚ùå NEVER use `wc -l` or any manual counting method
- ‚ùå NEVER count lines any other way - this is a -100% automatic failure
- ‚úÖ MUST specify both -b (base branch) and -c (current branch) parameters
- ‚úÖ Base branch MUST be phase integration branch (NOT "main")

**Failure to use the line counter tool = AUTOMATIC -100% GRADE**

## State Context
This state is responsible for injecting R213 parallelization metadata into wave implementation plans before any agent spawning occurs.

## R213 Metadata Injection Protocol

**CRITICAL**: This metadata MUST be injected BEFORE spawning Code Reviewers or SW Engineers!

```bash
# Example metadata to inject into wave plan:
EFFORT_METADATA:
  effort_id: "E3.1.1"
  name: "sync-engine-foundation"
  can_parallelize: false
  blocks: ["E3.1.2", "E3.1.3", "E3.1.4", "E3.1.5"]
  dependencies: []
  estimated_lines: 600
  assigned_to: "sw-engineer-1"
  working_directory: "/efforts/phase3/wave1/sync-engine-foundation"
  branch: "phase3/wave1/sync-engine-foundation"
```

## Critical Requirements

1. **READ** the wave implementation plan with Read tool
2. **IDENTIFY** all efforts in the wave
3. **INJECT** parallelization metadata for EACH effort
4. **SAVE** the updated plan
5. **VERIFY** metadata is present before proceeding
6. **TRANSITION** to next state in mandatory sequence

## State Transitions

- **FROM**: Previous state in mandatory sequence
- **TO**: Next state per R234 mandatory traversal
- **CANNOT SKIP**: This state is part of mandatory sequence

## Validation Before Transition

```bash
validate_metadata_injection() {
    echo "üîç Validating R213 metadata injection..."
    
    # Check each effort has metadata
    for effort in efforts/phase${PHASE}/wave${WAVE}/*/; do
        if ! grep -q "can_parallelize:" "${effort}/IMPLEMENTATION-PLAN.md"; then
            echo "‚ùå FATAL: Missing parallelization metadata in ${effort}"
            exit 213
        fi
    done
    
    echo "‚úÖ All efforts have R213 metadata"
}
```

## Next Steps

After successfully injecting metadata:
1. Update orchestrator-state.json (R288)
2. Commit and push changes (R288)
3. Check TodoWrite for pending items (R232)
4. Transition to next mandatory state (R234)

## R322 VIOLATION DETECTION

If you find yourself:
- Starting work for a new state without /continue-orchestrating
- Transitioning without stopping after state file commit
- Continuing after completing state work

**STOP IMMEDIATELY - You are violating R322!**
