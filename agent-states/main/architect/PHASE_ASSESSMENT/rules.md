# PHASE_ASSESSMENT State Rules

## üî¥üî¥üî¥ CRITICAL: REPORT LOCATION REQUIREMENTS üî¥üî¥üî¥

**YOU MUST CREATE THE ASSESSMENT REPORT IN THE EXACT LOCATION:**
```bash
# MANDATORY LOCATION:
Directory: phase-assessments/phase{PHASE_NUMBER}/
Filename:  PHASE-{PHASE_NUMBER}-ASSESSMENT-REPORT.md
Full path: phase-assessments/phase{PHASE_NUMBER}/PHASE-{PHASE_NUMBER}-ASSESSMENT-REPORT.md

# EXAMPLE for Phase 1:
mkdir -p phase-assessments/phase1
Write phase-assessments/phase1/PHASE-1-ASSESSMENT-REPORT.md

# WRONG LOCATIONS (WILL FAIL):
‚ùå ~/PHASE-1-ASSESSMENT-REPORT.md              # Root directory
‚ùå PHASE-1-ASSESSMENT-REPORT.md                # Current directory
‚ùå ./PHASE-1-ASSESSMENT-REPORT.md              # Current directory
‚ùå reports/PHASE-1-ASSESSMENT-REPORT.md        # Wrong directory
‚ùå phase1/PHASE-1-ASSESSMENT-REPORT.md         # Missing parent directory

# CORRECT LOCATION (ONLY THIS WORKS):
‚úÖ phase-assessments/phase1/PHASE-1-ASSESSMENT-REPORT.md
```

**VERIFICATION FUNCTION - USE THIS:**
```bash
verify_report_location() {
    local PHASE=$1
    local EXPECTED="phase-assessments/phase${PHASE}/PHASE-${PHASE}-ASSESSMENT-REPORT.md"
    
    if [[ ! -f "$EXPECTED" ]]; then
        echo "‚ùå CRITICAL ERROR: Report not in correct location!"
        echo "‚ùå Expected: $EXPECTED"
        echo "‚ùå Orchestrator will NOT find your report!"
        exit 1
    fi
    echo "‚úÖ Report in correct location: $EXPECTED"
}

# ALWAYS verify after creating:
verify_report_location 1  # For Phase 1
```

**PENALTY FOR WRONG LOCATION: -50% grading penalty, orchestrator cannot proceed**

## üî¥üî¥üî¥ MANDATORY MEASUREMENT RULE - R304 üî¥üî¥üî¥

### R304: Mandatory Line Counter Tool Enforcement
**File**: `$CLAUDE_PROJECT_DIR/rule-library/R304-mandatory-line-counter-enforcement.md`
**Criticality**: BLOCKING - Manual counting = AUTOMATIC -100% FAILURE

**ABSOLUTE REQUIREMENTS:**
- ‚úÖ MUST use `$CLAUDE_PROJECT_DIR/tools/line-counter.sh` for ALL line counting
- ‚ùå NEVER use `wc -l` or any manual counting method
- ‚ùå NEVER count lines any other way - this is a -100% automatic failure
- ‚úÖ MUST specify both -b (base branch) and -c (current branch) parameters
- ‚úÖ Base branch MUST be phase integration branch (NOT "main")

**Failure to use the line counter tool = AUTOMATIC -100% GRADE**

## üî¥üî¥üî¥ CRITICAL: ARCHITECT ROLE LIMITATIONS üî¥üî¥üî¥

**THE ARCHITECT IS AN ASSESSOR, NOT A DECIDER:**
- ‚úÖ You assess phase quality and compliance
- ‚úÖ You recommend proceeding or requesting changes
- ‚ùå You CANNOT end the project
- ‚ùå You CANNOT skip phases
- ‚ùå You CANNOT decide that "the MVP is complete"
- ‚ùå You CANNOT terminate Phase 2 or any other phase

**MANDATORY PRINCIPLE**: Every phase in the plan MUST be executed and assessed. Even if Phase 1 delivers a working system, Phase 2 and all subsequent phases MUST still be implemented.

## üö®üö®üö® MANDATORY PHASE ASSESSMENT REPORT - BLOCKING REQUIREMENT üö®üö®üö®

### üö®üö®üö® RULE R257.0.0 - Mandatory Phase Assessment Report [BLOCKING]
**Source:** rule-library/R257-mandatory-phase-assessment-report.md
**Criticality:** BLOCKING - Phase cannot complete without this

**YOU MUST CREATE A PERMANENT ASSESSMENT REPORT FILE:**
- **File Name**: `PHASE-{N}-ASSESSMENT-REPORT.md`
- **Location**: `phase-assessments/phase{N}/` ‚ö†Ô∏è SEE CRITICAL LOCATION SECTION ABOVE ‚ö†Ô∏è
- **When**: BEFORE signaling assessment complete
- **Verification**: Orchestrator will verify file exists AT EXACT LOCATION

**üî¥ CRITICAL STEPS - FOLLOW EXACTLY:**
```bash
# Step 1: Determine phase number
PHASE=1  # or 2, 3, etc.

# Step 2: CREATE DIRECTORY (MANDATORY!)
mkdir -p phase-assessments/phase${PHASE}

# Step 3: Set report path (USE EXACT PATH!)
REPORT_FILE="phase-assessments/phase${PHASE}/PHASE-${PHASE}-ASSESSMENT-REPORT.md"

# Step 4: Create report with Write tool
# Use Write tool with EXACT path: phase-assessments/phase1/PHASE-1-ASSESSMENT-REPORT.md

# Step 5: Verify location (MANDATORY!)
if [[ ! -f "$REPORT_FILE" ]]; then
    echo "‚ùå FAILED: Report not at $REPORT_FILE"
    exit 1
fi

# Step 6: Commit and push
git add "$REPORT_FILE"
git commit -m "assessment: Phase ${PHASE} assessment report - ${DECISION}"
git push

# Step 7: Final verification
ls -la phase-assessments/phase${PHASE}/
cat "$REPORT_FILE" | head -5
```

**‚ö†Ô∏è COMMON MISTAKES TO AVOID:**
- ‚ùå DON'T create in root directory
- ‚ùå DON'T forget to create parent directories
- ‚ùå DON'T use relative paths
- ‚ùå DON'T skip verification
- ‚úÖ DO use exact path: phase-assessments/phase{N}/PHASE-{N}-ASSESSMENT-REPORT.md

**VIOLATIONS:**
- ‚ùå Providing verbal assessment without report = BLOCKING FAILURE
- ‚ùå Missing mandatory sections = INVALID ASSESSMENT
- ‚ùå Not committing report = LOST ASSESSMENT
- ‚ùå Orchestrator cannot proceed without verified report

---

## Core Architecture Assessment Rules

---
### üî¥üî¥üî¥ RULE R308 - Incremental Development Chain Validation
**Source:** rule-library/R308-incremental-branching-strategy.md
**Criticality:** CORE TENANT - Validates trunk-based development

MANDATE: Verify the complete incremental development chain for this phase:
- Each wave built on previous wave's integration
- No waves branched from stale main 
- Phase integration includes all waves incrementally
- Next phase will branch from this phase's integration

VALIDATION CHECKLIST:
```bash
‚úÖ Wave 1 branched from correct base (main or prev phase integration)
‚úÖ Wave 2 branched from Wave 1 integration
‚úÖ Wave 3 branched from Wave 2 integration (if exists)
‚úÖ All waves integrated incrementally, not in "big bang"
‚úÖ Phase integration branch created and ready for next phase
```

**FAILURE TO MAINTAIN INCREMENTAL CHAIN = -100% PROJECT FAILURE**
---

---
### üö®üö®üö® RULE R297 - Architect Split Detection Protocol
**Source:** rule-library/R297-architect-split-detection-protocol.md
**Criticality:** BLOCKING - Must check splits BEFORE measuring integration

MANDATE: Check split_count in orchestrator-state.json BEFORE measuring any effort.
If split_count > 0, the effort was already split and is COMPLIANT.
Integration branches merge all splits (will exceed limits - EXPECTED).
Measure ORIGINAL effort branches, NOT integration branches.
PRs come from effort branches, NOT integration.
---

---
### ‚ÑπÔ∏è RULE R071.0.0 - Phase Architectural Integrity Assessment
**Source:** rule-library/RULE-REGISTRY.md#R071
**Criticality:** INFO - Best practice

MANDATE: Architect must assess architectural integrity before
phase completion. Evaluate structural soundness, pattern
compliance, and integration readiness of all phase components.

CRITERIA:
- KCP multi-tenancy pattern consistency
- API design stability and backwards compatibility
- Resource hierarchy and namespace isolation
- Controller pattern adherence
- Performance implications at enterprise scale
---

---
### ‚ÑπÔ∏è RULE R072.0.0 - KCP Pattern Compliance Verification
**Source:** rule-library/RULE-REGISTRY.md#R072
**Criticality:** INFO - Best practice

MANDATE: Verify all phase implementations adhere to KCP
architectural patterns including logical clusters, workspace
isolation, and multi-tenancy constraints.

VERIFICATION POINTS:
- LogicalCluster field presence in all CRDs
- Workspace-aware controllers and indexing
- ClusterRole vs Role usage patterns
- Cross-workspace reference handling
- Resource quota and limit enforcement
---

---
### ‚ÑπÔ∏è RULE R073.0.0 - Phase Completion Prerequisites
**Source:** rule-library/RULE-REGISTRY.md#R073
**Criticality:** INFO - Best practice

MANDATE: Before approving phase completion, verify all waves
are integrated, tested, and meet architectural standards.

PREREQUISITES:
- All wave integration branches merged successfully
- No architectural debt or anti-patterns introduced
- API compatibility maintained with previous phases
- Performance benchmarks meet enterprise requirements
- Security posture maintained or improved
---

---
### ‚ÑπÔ∏è RULE R037.0.0 - KCP Resource Pattern Enforcement
**Source:** rule-library/RULE-REGISTRY.md#R037
**Criticality:** INFO - Best practice

MANDATE: All Kubernetes resources must follow KCP multi-tenant
patterns with proper workspace isolation and logical cluster
field usage.

ENFORCEMENT AREAS:
- CRD schema includes LogicalCluster metadata
- Controllers use workspace-scoped clients
- RBAC follows least-privilege workspace boundaries
- Resource names avoid cross-workspace conflicts
- Event handling respects workspace isolation
---

## State-Specific Context

### PHASE_ASSESSMENT State Purpose
This state is entered when a complete phase (containing multiple waves) needs architectural review before transitioning to the next phase. The architect evaluates system-wide consistency, integration quality, and readiness for next phase work.

### State Transitions

**ENTRY CONDITIONS:**
- All waves in current phase marked as `WAVE_COMPLETE`
- Phase integration branch created and tested
- Orchestrator requests phase assessment

**EXIT CONDITIONS:**
- **PROCEED_NEXT_PHASE**: Phase meets all architectural standards ‚Üí Continue to next phase
- **CHANGES_REQUIRED**: Minor issues identified ‚Üí Return specific fixes to orchestrator
- **PHASE_FAILED**: Major architectural problems ‚Üí Halt progression, require redesign

**üö®üö®üö® FORBIDDEN DECISIONS - NEVER ALLOWED IN PHASE_ASSESSMENT üö®üö®üö®**:
- ‚ùå END_PHASE: The architect CANNOT end phases
- ‚ùå PROJECT_COMPLETE: The architect CANNOT end the project
- ‚ùå END_PROJECT: The architect CANNOT terminate the project
- ‚ùå SKIP_PHASE: The architect CANNOT skip phases
- ‚ùå SKIP_TO_FINAL: The architect CANNOT skip to final integration

**‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ARCHITECT AUTHORITY LIMITS ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è**:
- The architect assesses phases but CANNOT control project flow
- The architect CANNOT end the project or skip phases
- ALL phases in the plan MUST be executed and assessed
- Even if Phase 1 seems to "complete the MVP", Phase 2 MUST still be executed
- Only the ORCHESTRATOR decides when the project is complete

**STATE TRANSITION FLOW:**
```
PHASE_ASSESSMENT ‚Üí [Assessment Complete] ‚Üí Decision State
‚îú‚îÄ PROCEED_NEXT_PHASE ‚Üí Next Phase Planning
‚îú‚îÄ CHANGES_REQUIRED ‚Üí Fix Cycle (return to orchestrator)
‚îî‚îÄ PHASE_FAILED ‚Üí Architecture Redesign Required
```

## Assessment Criteria Matrix

| Area | Critical | Important | Nice-to-Have |
|------|----------|-----------|--------------|
| KCP Pattern Compliance | 100% | - | - |
| API Backwards Compatibility | 100% | - | - |
| Multi-tenancy Isolation | 100% | - | - |
| Performance at Scale | - | 95% | - |
| Code Quality Metrics | - | 90% | 100% |
| Documentation Coverage | - | 85% | 95% |

## Architecture Decision Requirements

### MUST ASSESS:
1. **Structural Integrity**: Are all components properly integrated?
2. **Pattern Consistency**: Do implementations follow KCP patterns uniformly?
3. **Scalability**: Will the phase handle enterprise-scale workloads?
4. **Security Posture**: Are multi-tenancy boundaries secure?
5. **API Stability**: Are APIs ready for production consumption?

### MUST DOCUMENT (IN THE MANDATORY ASSESSMENT REPORT FILE):
- **PRIMARY**: Create report at EXACT location per R257:
  ```
  phase-assessments/phase{N}/PHASE-{N}-ASSESSMENT-REPORT.md
  Example: phase-assessments/phase1/PHASE-1-ASSESSMENT-REPORT.md
  ```
- **NEVER CREATE IN ROOT DIRECTORY** - Orchestrator won't find it!
- Architecture decision record for phase approval/rejection
- Specific issues requiring correction (if CHANGES_REQUIRED)
- Performance benchmark results and analysis
- Security assessment findings
- Integration test results summary
- All documentation MUST be in the assessment report file AT CORRECT LOCATION
- Verbal/inline responses are NOT sufficient
- Report in wrong location = INVALID ASSESSMENT

### CRITICAL FAILURE CONDITIONS:
- **IMMEDIATE PHASE_FAILED**: Security vulnerabilities, data leakage between workspaces
- **IMMEDIATE PHASE_FAILED**: Breaking changes to public APIs without migration path

## R344: Report Metadata Location to State File

**MANDATORY: After creating PHASE-ASSESSMENT-REPORT.md, MUST report location**

```bash
# After writing assessment report, update state file with location (R344 MANDATORY)
PHASE=$(jq -r '.current_phase' "$CLAUDE_PROJECT_DIR/orchestrator-state.json")
REPORT_PATH="$(pwd)/phase-assessments/phase${PHASE}/PHASE-${PHASE}-ASSESSMENT-REPORT.md"
ASSESSMENT_ID="phase${PHASE}-assessment-$(date +%Y%m%d-%H%M%S)"

# Update state file with assessment location
yq -i ".metadata_locations.architect_assessments.\"$ASSESSMENT_ID\" = {
    \"file_path\": \"$REPORT_PATH\",
    \"created_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
    \"created_by\": \"architect\",
    \"phase\": $PHASE,
    \"assessment_type\": \"phase\",
    \"decision\": \"$DECISION\"
}" "$CLAUDE_PROJECT_DIR/orchestrator-state.json"

# Commit state update
cd "$CLAUDE_PROJECT_DIR"
git add orchestrator-state.json
git commit -m "state: report phase assessment location per R344"
git push

echo "‚úÖ R344 COMPLETE: Assessment location reported to state file"
```
