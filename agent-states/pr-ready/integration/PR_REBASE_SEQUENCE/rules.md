# PR_REBASE_SEQUENCE State Rules

## üî¥üî¥üî¥ STATE PURPOSE: Execute Sequential Rebasing üî¥üî¥üî¥

### üî¥üî¥üî¥ RULE R368 - PR Sequential Rebase Protocol [SUPREME LAW]
**Source:** `$CLAUDE_PROJECT_DIR/rule-library/R368-pr-sequential-rebase-protocol.md`
**Criticality:** SUPREME LAW - Incorrect rebase order = merge conflicts

This state implements R368 requirements for sequential rebasing to ensure R363 compliance.

### MANDATORY ACTIONS (R233 + R368 COMPLIANT)
Upon entering this state, IMMEDIATELY:

1. **Load rebase sequence**
   ```bash
   # Read assigned rebase order
   cat PR-REBASE-SEQUENCE.json
   BRANCHES=$(jq -r '.rebase_order[]' PR-REBASE-SEQUENCE.json)
   ```

2. **Execute sequential rebasing**
   ```bash
   # Start with first branch on main
   FIRST_BRANCH=$(echo $BRANCHES | cut -d' ' -f1)
   git checkout $FIRST_BRANCH
   git rebase main

   if [ $? -ne 0 ]; then
     # Handle conflicts
     echo "Conflicts in $FIRST_BRANCH"
     # Document conflict files
     git status --porcelain | grep "^UU"

     # Apply standard resolution
     git checkout --theirs .  # For add/add conflicts
     git add -A
     git rebase --continue
   fi

   git push origin $FIRST_BRANCH --force-with-lease

   # Each subsequent branch on previous
   PREV_BRANCH=$FIRST_BRANCH
   for BRANCH in $(echo $BRANCHES | cut -d' ' -f2-); do
     git checkout $BRANCH
     git rebase $PREV_BRANCH

     if [ $? -ne 0 ]; then
       # Document and resolve conflicts
       echo "Conflicts rebasing $BRANCH on $PREV_BRANCH"
       git status --porcelain | grep "^UU"

       # Standard resolution for known patterns
       git checkout --theirs pkg/certs/*  # Known conflict area
       git add -A
       git rebase --continue
     fi

     git push origin $BRANCH --force-with-lease
     PREV_BRANCH=$BRANCH
   done
   ```

3. **Create incremental branches if needed**
   ```bash
   # For truly incremental PRs
   for BRANCH in $BRANCHES; do
     if [ "$CREATE_INCREMENTAL" = "true" ]; then
       # Get only new changes
       git diff $PREV_BRANCH..$BRANCH > /tmp/$BRANCH.patch

       git checkout $PREV_BRANCH
       git checkout -b ${BRANCH}-incremental
       git apply /tmp/$BRANCH.patch
       git add -A
       git commit -m "feat: Incremental changes for $BRANCH"
       git push origin ${BRANCH}-incremental
     fi
   done
   ```

4. **Document conflict resolutions**
   ```markdown
   # Conflict Resolution Log

   ## Branch: phase1-wave1-effort1
   - Rebased on: main
   - Conflicts: None

   ## Branch: phase1-wave1-effort2
   - Rebased on: phase1-wave1-effort1
   - Conflicts in: pkg/certs/extractor.go
   - Resolution: Accepted incoming (--theirs)
   ```

### EXIT CRITERIA
‚úÖ All branches rebased in sequence
‚úÖ Conflicts resolved and documented
‚úÖ Branches pushed to origin
‚úÖ Dependency chain established

### OUTPUT FILES
- `PR-REBASE-REPORT.md`
- `PR-CONFLICT-RESOLUTIONS.md`
- `PR-INCREMENTAL-BRANCHES.txt` (if applicable)

### CONFLICT RESOLUTION STRATEGY
**Standard patterns:**
- `pkg/certs/*` ‚Üí Use --theirs (accept incoming)
- Add/add conflicts ‚Üí Use --theirs
- Modify/delete ‚Üí Investigate case-by-case
- Whitespace conflicts ‚Üí Auto-resolve

### PROHIBITED ACTIONS
‚ùå Do NOT skip conflict resolution
‚ùå Do NOT break dependency chain
‚ùå Do NOT merge branches (only rebase)
‚ùå Do NOT lose commits

### ERROR RECOVERY
- Rebase fails ‚Üí Reset to original SHA
- Unresolvable conflict ‚Üí Document and escalate
- Push rejected ‚Üí Check branch protection
- Lost commits ‚Üí Recover from reflog