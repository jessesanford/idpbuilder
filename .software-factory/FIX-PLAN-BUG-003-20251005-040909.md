# FIX PLAN: BUG-cascade-20251005-013208-003

## Bug Identification

**Bug ID**: BUG-cascade-20251005-013208-003
**Cascade ID**: cascade-20251005-013208
**Severity**: HIGH
**Detected At**: 2025-10-04T15:56:01Z
**Detected By**: R291 Build Gate - Phase 1 Wave 2 Integration
**Category**: build_failure

### Error Description
```
undefined: retry.DefaultBackoff
```

### File Locations
- **Location**: `pkg/push/auth/authenticator.go:116:20`
- **Function**: `AuthenticateWithRetry()`
- **Line**: `strategy := retry.DefaultBackoff()`

### Affected Effort
- **Effort ID**: E1.2.2-split-001
- **Effort Name**: registry-authentication-split-001
- **Branch**: idpbuilder-push-oci/phase1/wave2/registry-authentication-split-001
- **Path**: efforts/phase1/wave2/E1.2.2-registry-authentication-split-001

## Root Cause Analysis

### What Caused the Undefined Error
The code in `authenticator.go` references `retry.DefaultBackoff()` but the `retry` package is either:
1. **Not imported** at all
2. **Imported incorrectly** (wrong import path)
3. **Function doesn't exist** in the retry package (wrong function name)

### Investigation Needed
```bash
# Check imports in authenticator.go
grep -n "import" pkg/push/auth/authenticator.go

# Check if retry package exists
ls -la pkg/push/auth/retry/ 2>/dev/null || echo "retry package not found"

# Check for retry package in parent directory
ls -la pkg/push/retry/ 2>/dev/null || echo "retry package not found"

# Check actual function name in retry package
grep -rn "func.*Backoff" pkg/push/ 2>/dev/null
```

### Why It Wasn't Caught Earlier
This is a **missing import or incorrect reference** issue:
- Split-001 was responsible for "Core authentication logic, credentials, and error handling"
- The retry package might be in split-002 (E1.2.2-split-002: "Retry mechanism with backoff and retry logic")
- Dependency ordering issue between splits

### Split Context
From orchestrator state:
- **Split-001 Description**: "Core authentication logic, credentials, and error handling"
- **Split-002 Description**: "Retry mechanism with backoff and retry logic"
- **Problem**: Split-001 tries to USE retry logic that's DEFINED in split-002

### Files Involved
- `pkg/push/auth/authenticator.go:116` - Uses retry.DefaultBackoff()
- Retry package location (TBD - needs investigation)

## Fix Strategy

### Approach: Add Missing Import or Fix Reference
**Multiple possible fixes depending on investigation**

#### Option A: Import Missing retry Package
If retry package exists but not imported:
```go
import (
    "github.com/cnoe-io/idpbuilder/pkg/push/retry"
)
```

#### Option B: Fix Function Name
If function is named differently:
```go
// Instead of:
strategy := retry.DefaultBackoff()

// Use correct function name, e.g.:
strategy := retry.NewBackoff()
// OR
strategy := retry.DefaultStrategy()
```

#### Option C: Define retry Package in split-001
If retry logic should be in split-001:
- Create pkg/push/retry/ package
- Implement DefaultBackoff() function
- Ensure it's included in split-001

#### Option D: Remove retry Usage Temporarily
If retry is in split-002 and split-001 should be independent:
- Remove AuthenticateWithRetry() from split-001
- Move it to split-002 where retry package is defined
- Keep only basic authentication in split-001

### Recommended Approach: Option A + Investigation
1. **Investigate** where retry package is located
2. **Add import** if package exists
3. **Verify function name** matches
4. **Test build** succeeds

### Files to Modify
**In the original effort directory** (`efforts/phase1/wave2/E1.2.2-registry-authentication-split-001/`):

1. **INVESTIGATE FIRST**: Find retry package location
   ```bash
   find . -name "retry.go" -o -name "backoff.go"
   ```

2. **MODIFY**: `pkg/push/auth/authenticator.go`
   - Add import for retry package (if missing)
   - Fix function name (if wrong)
   - Ensure correct usage

### Expected Outcome
After fix:
- `retry.DefaultBackoff()` resolves correctly
- Build succeeds without "undefined" error
- Authentication with retry works as designed
- Integration workspace compiles successfully

## Implementation Steps

### Step 1: Navigate to Effort Directory
```bash
cd /home/vscode/workspaces/idpbuilder-push-oci/efforts/phase1/wave2/E1.2.2-registry-authentication-split-001
```

### Step 2: Investigate retry Package Location
```bash
# Find retry package
find . -type f -name "*.go" | xargs grep -l "func.*DefaultBackoff" 2>/dev/null

# Check common locations
ls -la pkg/push/retry/ 2>/dev/null
ls -la pkg/retry/ 2>/dev/null

# Check imports in authenticator.go
head -20 pkg/push/auth/authenticator.go | grep -A 10 "import"
```

### Step 3: Identify the Fix
Based on investigation results:

**If retry package exists in project:**
```bash
# Add import to authenticator.go
# Example:
# import (
#     "github.com/cnoe-io/idpbuilder/pkg/push/retry"
# )
```

**If function name is wrong:**
```bash
# Check actual function name
grep -rn "func.*Backoff" pkg/

# Use correct function name in authenticator.go
```

**If retry package doesn't exist:**
```bash
# Create minimal retry package in split-001
mkdir -p pkg/push/retry
# Create retry/backoff.go with DefaultBackoff() function
```

### Step 4: Implement Fix
```bash
# Edit authenticator.go
# Add missing import or fix function reference
```

### Step 5: Verify Fix Locally
```bash
# Clean build
go clean ./...

# Build the package
go build ./pkg/push/auth/

# Should compile without "undefined: retry.DefaultBackoff" error
```

### Step 6: Commit and Push
```bash
git add pkg/push/auth/authenticator.go
# If created retry package:
git add pkg/push/retry/

git commit -m "fix(BUG-003): resolve undefined retry.DefaultBackoff

- Added missing import for retry package
- Fixed reference to DefaultBackoff function
- Resolves BUG-cascade-20251005-013208-003

Cascade-ID: cascade-20251005-013208"

git push
```

## Validation Steps

### Build Validation
```bash
# Navigate to effort directory
cd /home/vscode/workspaces/idpbuilder-push-oci/efforts/phase1/wave2/E1.2.2-registry-authentication-split-001

# Clean build
go clean ./...

# Build the auth package
go build ./pkg/push/auth/

# Expected: No errors, successful compilation
```

### Import Verification
```bash
# Verify import is present
grep -A 10 "^import" pkg/push/auth/authenticator.go | grep retry

# Should show retry package import
```

### Function Reference Check
```bash
# Verify DefaultBackoff is used correctly
grep -n "retry.DefaultBackoff" pkg/push/auth/authenticator.go

# Should resolve without errors after fix
```

### Integration Test
```bash
# After fix is pushed, integration agent will verify
# Build should pass in Wave 2 integration workspace
```

## Code Example

### Before Fix (missing import):
```go
// authenticator.go
package auth

import (
    "context"
    "fmt"
    // Missing: retry package import
)

func (a *Authenticator) AuthenticateWithRetry(ctx context.Context, registry string) error {
    if err := a.Validate(); err != nil {
        return fmt.Errorf("invalid authenticator configuration: %w", err)
    }

    strategy := retry.DefaultBackoff()  // ❌ ERROR: undefined retry
    // ...
}
```

### After Fix (with import):
```go
// authenticator.go
package auth

import (
    "context"
    "fmt"
    "github.com/cnoe-io/idpbuilder/pkg/push/retry"  // ✅ ADDED
)

func (a *Authenticator) AuthenticateWithRetry(ctx context.Context, registry string) error {
    if err := a.Validate(); err != nil {
        return fmt.Errorf("invalid authenticator configuration: %w", err)
    }

    strategy := retry.DefaultBackoff()  // ✅ WORKS: retry is imported
    // ...
}
```

## Alternative Fix: Minimal Retry Package

If retry package doesn't exist, create it in split-001:

```go
// pkg/push/retry/backoff.go
package retry

import "time"

// BackoffStrategy defines retry backoff behavior
type BackoffStrategy struct {
    InitialDelay time.Duration
    MaxDelay     time.Duration
    Multiplier   float64
}

// DefaultBackoff returns default backoff strategy
func DefaultBackoff() BackoffStrategy {
    return BackoffStrategy{
        InitialDelay: 100 * time.Millisecond,
        MaxDelay:     5 * time.Second,
        Multiplier:   2.0,
    }
}
```

Then import it in authenticator.go:
```go
import (
    "github.com/cnoe-io/idpbuilder/pkg/push/retry"
)
```

## Critical Notes

### R362 Compliance
- **NO architectural changes** - just fixing import
- **NO library changes** - using existing retry package (or minimal implementation)
- **NO pattern changes** - maintaining retry pattern

### R383 Compliance
- This fix plan is in `.software-factory/` with timestamp
- Fix will be in production code (`pkg/push/auth/`)
- Clear separation maintained

### Minimal Change Principle
- Add missing import (1-2 lines)
- OR fix function name (1 line)
- OR create minimal retry package (if necessary)
- No refactoring beyond fixing the reference

### Split Boundary Awareness
- Fix is in split-001 only
- May need to coordinate with split-002 if retry package is there
- Verify split dependencies are correct

## Investigation Checklist

Before implementing fix, SW Engineer must verify:
- [ ] Where is retry package located?
- [ ] What is the correct import path?
- [ ] What is the correct function name?
- [ ] Is retry in split-001 or split-002?
- [ ] Should split-001 depend on split-002 or have own retry?

## Metadata

**Cascade ID**: cascade-20251005-013208
**Bug ID**: BUG-cascade-20251005-013208-003
**Effort ID**: E1.2.2-split-001
**Split Number**: 001 of 002
**Phase**: 1
**Wave**: 2
**Created**: 2025-10-05T04:09:09Z
**Fix Approach**: Add import or fix reference
**Expected Lines Changed**: 1-30 lines (depending on approach)
**Risk Level**: LOW-MEDIUM (simple import fix to creating package)
**Testing Required**: Build validation
**Investigation Required**: YES - must find retry package first

## Success Criteria

✅ `retry.DefaultBackoff()` resolves without errors
✅ Build succeeds without "undefined" errors
✅ Correct import path used
✅ Function name matches actual implementation
✅ Integration workspace build passes

## Special Instructions for SW Engineer

**FIRST**: Investigate retry package location
**THEN**: Choose appropriate fix approach
**VERIFY**: Function signature matches usage
**TEST**: Build succeeds locally
**COMMIT**: With clear explanation of fix chosen

---

**Next Steps**: Assign to SW Engineer for investigation and implementation
