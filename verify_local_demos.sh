#!/bin/bash
echo "üî¥üî¥üî¥ R291 MANDATORY GATES CHECK (LOCAL) üî¥üî¥üî¥"
echo "Started: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

FAILED=false
PASSED_COUNT=0
FAILED_COUNT=0
WARNING_COUNT=0
EFFORTS_TESTED=""

# Phase 2 Wave 1 efforts
echo "=== PHASE 2 WAVE 1 LOCAL DEMO VERIFICATION ==="
echo ""

# Check each effort for demo files
for effort in image-builder gitea-client gitea-client-split-001 gitea-client-split-002; do
    echo "üé¨ [GATE] Checking demos in: efforts/phase2/wave1/$effort"
    
    EFFORT_DIR="efforts/phase2/wave1/$effort"
    
    # Check if effort directory exists
    if [ -d "$EFFORT_DIR" ]; then
        echo "  ‚úÖ Effort directory exists"
        
        # Check for demo-features.sh (MANDATORY)
        if [ -f "$EFFORT_DIR/demo-features.sh" ]; then
            echo "  ‚úÖ demo-features.sh found"
            
            # Verify it's executable
            if [ -x "$EFFORT_DIR/demo-features.sh" ]; then
                echo "  ‚úÖ demo-features.sh is executable"
            else
                echo "  ‚ö†Ô∏è  demo-features.sh is not executable"
                ((WARNING_COUNT++))
            fi
            
            # Check file size (should have content)
            DEMO_SIZE=$(wc -c < "$EFFORT_DIR/demo-features.sh")
            if [ $DEMO_SIZE -gt 100 ]; then
                echo "  ‚úÖ demo-features.sh has content ($DEMO_SIZE bytes)"
                ((PASSED_COUNT++))
                EFFORTS_TESTED="$EFFORTS_TESTED\n  ‚úÖ $effort: DEMO IMPLEMENTED"
            else
                echo "  üî¥ demo-features.sh is too small ($DEMO_SIZE bytes)"
                ((FAILED_COUNT++))
                FAILED=true
                EFFORTS_TESTED="$EFFORTS_TESTED\n  ‚ùå $effort: DEMO STUB ONLY"
            fi
        else
            echo "  üî¥ demo-features.sh missing!"
            ((FAILED_COUNT++))
            FAILED=true
            EFFORTS_TESTED="$EFFORTS_TESTED\n  ‚ùå $effort: NO DEMO FOUND"
        fi
        
        # Check for DEMO.md documentation (RECOMMENDED)
        if [ -f "$EFFORT_DIR/DEMO.md" ]; then
            echo "  ‚úÖ DEMO.md documentation found"
            DEMO_MD_SIZE=$(wc -c < "$EFFORT_DIR/DEMO.md")
            echo "  ‚úÖ DEMO.md size: $DEMO_MD_SIZE bytes"
        else
            echo "  ‚ö†Ô∏è  DEMO.md documentation missing"
            ((WARNING_COUNT++))
        fi
        
        # Check for test-data directory (OPTIONAL)
        if [ -d "$EFFORT_DIR/test-data" ]; then
            echo "  ‚úÖ test-data directory found"
            TEST_FILES=$(ls -1 "$EFFORT_DIR/test-data" 2>/dev/null | wc -l)
            echo "  ‚úÖ test-data contains $TEST_FILES files"
        else
            echo "  ‚ÑπÔ∏è  test-data directory not present (optional)"
        fi
    else
        echo "  üî¥ Effort directory not found!"
        ((FAILED_COUNT++))
        FAILED=true
        EFFORTS_TESTED="$EFFORTS_TESTED\n  ‚ùå $effort: DIRECTORY MISSING"
    fi
    echo ""
done

# Check for wave-level demo orchestration
echo "üé¨ [GATE] Checking wave-level demo orchestration"
if [ -f "efforts/phase2/wave1/wave-demo.sh" ]; then
    echo "  ‚úÖ wave-demo.sh found"
    if [ -x "efforts/phase2/wave1/wave-demo.sh" ]; then
        echo "  ‚úÖ wave-demo.sh is executable"
    else
        echo "  ‚ö†Ô∏è  wave-demo.sh is not executable"
        ((WARNING_COUNT++))
    fi
else
    echo "  ‚ö†Ô∏è  wave-demo.sh missing (recommended for orchestration)"
    ((WARNING_COUNT++))
fi
echo ""

echo "======================================="
echo "üìä VERIFICATION SUMMARY"
echo "======================================="
echo -e "Efforts tested:$EFFORTS_TESTED"
echo ""
echo "‚úÖ Passed: $PASSED_COUNT efforts"
echo "‚ùå Failed: $FAILED_COUNT efforts"
echo "‚ö†Ô∏è  Warnings: $WARNING_COUNT items"
echo ""

if [ "$FAILED" = true ]; then
    echo "üî¥üî¥üî¥ DEMO GATES FAILED - MUST ENTER ERROR_RECOVERY üî¥üî¥üî¥"
    echo ""
    echo "Required Actions:"
    echo "1. All efforts must have demo-features.sh with actual content"
    echo "2. Demo scripts must demonstrate real functionality"
    echo "3. Documentation (DEMO.md) should explain the demo"
    exit 1
fi

if [ $WARNING_COUNT -gt 0 ]; then
    echo "‚ö†Ô∏è  Some minor issues detected but not blocking"
fi

echo "‚úÖ‚úÖ‚úÖ ALL MANDATORY DEMO GATES PASSED ‚úÖ‚úÖ‚úÖ"
echo "Ready for RETROFIT_COMPLETE state"
exit 0