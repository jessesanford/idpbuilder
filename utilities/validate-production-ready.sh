#!/bin/bash
# üö® PRODUCTION READINESS VALIDATION SCRIPT
# Implements R271-R280 validation requirements

set -e

echo "================================================"
echo "üîç PRODUCTION READINESS VALIDATION"
echo "================================================"
echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
echo "================================================"

VALIDATION_PASSED=true
ERRORS=0
WARNINGS=0

# Function to detect project runtime
detect_project_runtime() {
    if [ -f "go.mod" ] || [ -f "go.sum" ]; then
        echo "go"
    elif [ -f "Cargo.toml" ]; then
        echo "rust"
    elif [ -f "package.json" ]; then
        echo "nodejs"
    elif [ -f "requirements.txt" ] || [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then
        echo "python"
    elif [ -f "pom.xml" ]; then
        echo "java"
    elif [ -f "Dockerfile" ]; then
        echo "docker"
    elif [ -f "Chart.yaml" ]; then
        echo "helm"
    elif [ -f "kustomization.yaml" ]; then
        echo "kustomize"
    elif [ -d ".terraform" ] || ls *.tf 2>/dev/null | head -1 > /dev/null; then
        echo "terraform"
    else
        echo "unknown"
    fi
}

# Function to validate Go project
validate_go_project() {
    echo "üîç Validating Go project..."
    
    # Module verification
    if ! go mod verify 2>/dev/null; then
        echo "‚ùå Go module verification failed"
        ((ERRORS++))
        return 1
    fi
    
    # Build validation
    if ! go build -o test-binary . 2>/dev/null && \
       ! go build -o test-binary ./cmd/... 2>/dev/null && \
       ! go build -o test-binary ./cmd/main.go 2>/dev/null; then
        echo "‚ùå Go build failed"
        ((ERRORS++))
        return 1
    fi
    
    # Test execution
    if ! go test ./... 2>/dev/null; then
        echo "‚ö†Ô∏è Go tests failing"
        ((WARNINGS++))
    fi
    
    # Binary execution
    if [ -f test-binary ]; then
        if ! ./test-binary --version 2>/dev/null && ! ./test-binary --help 2>/dev/null; then
            echo "‚ùå Binary doesn't execute properly"
            ((ERRORS++))
            return 1
        fi
        rm -f test-binary
    fi
    
    echo "‚úÖ Go validation passed"
    return 0
}

# Function to validate Node.js project
validate_nodejs_project() {
    echo "üîç Validating Node.js project..."
    
    # Dependency installation
    if [ -f "package-lock.json" ]; then
        if ! npm ci 2>/dev/null; then
            echo "‚ùå npm ci failed"
            ((ERRORS++))
            return 1
        fi
    else
        if ! npm install 2>/dev/null; then
            echo "‚ùå npm install failed"
            ((ERRORS++))
            return 1
        fi
    fi
    
    # Build if applicable
    if grep -q '"build"' package.json 2>/dev/null; then
        if ! npm run build 2>/dev/null; then
            echo "‚ùå npm build failed"
            ((ERRORS++))
            return 1
        fi
    fi
    
    # Test execution
    if ! npm test 2>/dev/null; then
        echo "‚ö†Ô∏è npm tests failing"
        ((WARNINGS++))
    fi
    
    echo "‚úÖ Node.js validation passed"
    return 0
}

# Function to validate Python project
validate_python_project() {
    echo "üîç Validating Python project..."
    
    # Create virtual environment
    python -m venv test-env 2>/dev/null || python3 -m venv test-env
    source test-env/bin/activate
    
    # Dependency installation
    if [ -f "requirements.txt" ]; then
        if ! pip install -r requirements.txt 2>/dev/null; then
            echo "‚ùå pip install failed"
            deactivate
            rm -rf test-env
            ((ERRORS++))
            return 1
        fi
    elif [ -f "setup.py" ]; then
        if ! pip install -e . 2>/dev/null; then
            echo "‚ùå setup.py install failed"
            deactivate
            rm -rf test-env
            ((ERRORS++))
            return 1
        fi
    fi
    
    # Test execution
    if ! pytest 2>/dev/null && ! python -m pytest 2>/dev/null; then
        echo "‚ö†Ô∏è Python tests not found or failing"
        ((WARNINGS++))
    fi
    
    deactivate
    rm -rf test-env
    echo "‚úÖ Python validation passed"
    return 0
}

# Function to validate Kubernetes project
validate_kubernetes_project() {
    echo "üîç Validating Kubernetes manifests..."
    
    # YAML validation
    for file in $(find . -name "*.yaml" -o -name "*.yml"); do
        if ! kubectl apply --dry-run=client -f "$file" 2>/dev/null; then
            echo "‚ùå Invalid manifest: $file"
            ((ERRORS++))
            return 1
        fi
    done
    
    # Helm chart validation if present
    if [ -f "Chart.yaml" ]; then
        if ! helm lint . 2>/dev/null; then
            echo "‚ùå Helm chart validation failed"
            ((ERRORS++))
            return 1
        fi
    fi
    
    echo "‚úÖ Kubernetes validation passed"
    return 0
}

# Function to validate Docker project
validate_docker_project() {
    echo "üîç Validating Docker project..."
    
    # Build image
    if ! docker build -t test-image:validation . 2>/dev/null; then
        echo "‚ùå Docker build failed"
        ((ERRORS++))
        return 1
    fi
    
    # Cleanup
    docker rmi test-image:validation 2>/dev/null || true
    
    echo "‚úÖ Docker validation passed"
    return 0
}

# Function to validate Terraform project
validate_terraform_project() {
    echo "üîç Validating Terraform project..."
    
    # Initialize
    if ! terraform init -backend=false 2>/dev/null; then
        echo "‚ùå Terraform init failed"
        ((ERRORS++))
        return 1
    fi
    
    # Validation
    if ! terraform validate 2>/dev/null; then
        echo "‚ùå Terraform validation failed"
        ((ERRORS++))
        return 1
    fi
    
    echo "‚úÖ Terraform validation passed"
    return 0
}

# Check 1: Integration Testing Branch
echo ""
echo "üìã Checking R272: Integration Testing Branch..."
CURRENT_BRANCH=$(git branch --show-current)
if [[ "$CURRENT_BRANCH" =~ integration-testing ]]; then
    echo "‚úÖ On integration-testing branch: $CURRENT_BRANCH"
else
    echo "‚ö†Ô∏è WARNING: Not on integration-testing branch (current: $CURRENT_BRANCH)"
    ((WARNINGS++))
fi

# Check 2: Main Branch Protection
echo ""
echo "üìã Checking R280: Main Branch Protection..."
if [ "$CURRENT_BRANCH" = "main" ]; then
    echo "‚ùå SUPREME LAW VIOLATION: On main branch!"
    echo "Software Factory must NEVER modify main!"
    exit 280
fi
echo "‚úÖ Not on main branch (R280 compliant)"

# Check 3: Runtime-Specific Validation
echo ""
echo "üìã Checking R273: Runtime-Specific Validation..."
RUNTIME=$(detect_project_runtime)
echo "Detected runtime: $RUNTIME"

case $RUNTIME in
    go) validate_go_project ;;
    nodejs) validate_nodejs_project ;;
    python) validate_python_project ;;
    kubernetes) validate_kubernetes_project ;;
    docker) validate_docker_project ;;
    terraform) validate_terraform_project ;;
    *)
        echo "‚ö†Ô∏è Unknown runtime - generic validation only"
        ((WARNINGS++))
        ;;
esac

# Check 4: Documentation
echo ""
echo "üìã Checking R276: Documentation Requirements..."
if [ ! -f "README.md" ]; then
    echo "‚ùå No README.md found"
    ((ERRORS++))
else
    echo "‚úÖ README.md exists"
fi

if [ ! -f "RUNBOOK.md" ] && [ ! -f "docs/runbook.md" ] && [ ! -f "docs/RUNBOOK.md" ]; then
    echo "‚ö†Ô∏è No RUNBOOK.md found"
    ((WARNINGS++))
else
    echo "‚úÖ RUNBOOK exists"
fi

# Check 5: Build Artifacts
echo ""
echo "üìã Checking R277: Build Artifacts..."
if [ "$RUNTIME" = "go" ]; then
    if go build . 2>/dev/null || go build ./cmd/... 2>/dev/null; then
        echo "‚úÖ Build produces artifacts"
    else
        echo "‚ùå Build fails to produce artifacts"
        ((ERRORS++))
    fi
elif [ "$RUNTIME" = "nodejs" ]; then
    if [ -d "dist" ] || [ -d "build" ] || [ -d "out" ]; then
        echo "‚úÖ Build artifacts found"
    else
        echo "‚ö†Ô∏è No obvious build artifacts"
        ((WARNINGS++))
    fi
fi

# Check 6: MASTER-PR-PLAN.md
echo ""
echo "üìã Checking R279: MASTER-PR-PLAN Requirement..."
if [ ! -f "MASTER-PR-PLAN.md" ]; then
    echo "‚ö†Ô∏è MASTER-PR-PLAN.md not yet created (will be generated)"
    ((WARNINGS++))
else
    echo "‚úÖ MASTER-PR-PLAN.md exists"
fi

# Final Summary
echo ""
echo "================================================"
echo "üìä VALIDATION SUMMARY"
echo "================================================"
echo "Runtime: $RUNTIME"
echo "Branch: $CURRENT_BRANCH"
echo "Errors: $ERRORS"
echo "Warnings: $WARNINGS"

if [ $ERRORS -gt 0 ]; then
    echo ""
    echo "‚ùå PRODUCTION READINESS: FAILED"
    echo "Fix the $ERRORS errors before proceeding to SUCCESS"
    exit 1
elif [ $WARNINGS -gt 0 ]; then
    echo ""
    echo "‚ö†Ô∏è PRODUCTION READINESS: PASSED WITH WARNINGS"
    echo "Consider addressing $WARNINGS warnings"
    exit 0
else
    echo ""
    echo "‚úÖ PRODUCTION READINESS: FULLY VALIDATED"
    echo "Software is ready for PR plan generation"
    exit 0
fi