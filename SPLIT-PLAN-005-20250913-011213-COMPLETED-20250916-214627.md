# SPLIT-PLAN-005: Controllers and Integration
## Split 005 of 5: Controllers, API, and Final Integration
**Planner**: Code Reviewer code-reviewer-1757726063 (sole planner for ALL splits)
**Parent Effort**: kind-cert-extraction

<!-- ORCHESTRATOR METADATA PLACEHOLDER - DO NOT REMOVE -->
<!-- The orchestrator will add infrastructure metadata below: -->
<!-- WORKING_DIRECTORY, BRANCH, REMOTE, BASE_BRANCH, etc. -->
<!-- SW Engineers MUST read this metadata to navigate to the correct directory -->
<!-- END PLACEHOLDER -->

## Boundaries (CRITICAL: All splits MUST reference SAME effort!)
- **Previous Split**: Split 004 of phase1/wave1/kind-cert-extraction
  - Path: efforts/phase1/wave1/kind-cert-extraction/split-004/
  - Branch: idpbuilder-oci-build-push/phase1/wave1/kind-cert-extraction-split-004
  - Summary: Complete CLI interface
- **This Split**: Split 005 of phase1/wave1/kind-cert-extraction
  - Path: efforts/phase1/wave1/kind-cert-extraction/split-005/
  - Branch: idpbuilder-oci-build-push/phase1/wave1/kind-cert-extraction-split-005
- **Next Split**: None (final split)
  - This completes the kind-cert-extraction effort

## Files in This Split (EXCLUSIVE - no overlap with other splits)
### Controllers Package (pkg/controllers/)
- pkg/controllers/localbuild/controller.go (~400 lines)
- pkg/controllers/localbuild/gitea.go (~150 lines)
- pkg/controllers/localbuild/installer.go (~160 lines)
- pkg/controllers/gitrepository/controller.go (~365 lines)
- pkg/controllers/gitrepository/gitea.go (~165 lines)
- pkg/controllers/custompackage/controller.go (~500 lines)
- Test files for controllers

### API Package (api/)
- api/v1alpha1/localbuild_types.go (~125 lines)
- api/v1alpha1/custom_package_types.go (~75 lines)
- api/v1alpha1/gitrepository_types.go (~95 lines)
- api/v1alpha1/zz_generated.deepcopy.go (generated)
- api/v1alpha1/groupversion_info.go (~20 lines)

### Supporting Packages
- globals/project.go (~30 lines)
- pkg/logger/handler.go (~230 lines)
- pkg/printer/ (all files, ~150 lines)
- pkg/resources/ (all files, ~200 lines)
- pkg/testutil/ (test utilities)

### Configuration Files
- hack/ directory (scripts and configs)
- docs/ directory (documentation)
- .github/ directory (CI/CD)
- .devcontainer/ (development setup)
- tests/e2e/e2e.go (~400 lines)

## Functionality
This split provides controllers and final integration:
- Kubernetes controllers for custom resources
- API type definitions (CRDs)
- Gitea integration for repositories
- Local build controller logic
- Custom package management
- Logging infrastructure
- Resource printing utilities
- E2E test framework
- CI/CD configuration

## Dependencies
- **All Previous Splits**: Uses all functionality
- Integrates certificate extraction (Split 001)
- Uses Kind operations (Split 002)
- Leverages build utilities (Split 003)
- Extends CLI commands (Split 004)

## Implementation Instructions
1. **Setup**:
   ```bash
   # Branch from Split 004
   cd efforts/phase1/wave1/kind-cert-extraction/split-005
   git checkout -b idpbuilder-oci-build-push/phase1/wave1/kind-cert-extraction-split-005
   
   # Merge all previous splits
   git merge [split-004-branch]
   ```

2. **Implementation**:
   - Implement all controllers
   - Define API types and CRDs
   - Add Gitea integration
   - Setup logging infrastructure
   - Add resource printers
   - Complete E2E tests

3. **Final Integration**:
   - Wire all components together
   - Ensure controllers use cert extraction
   - Connect to Kind cluster operations
   - Complete end-to-end workflows
   - Add comprehensive E2E tests

4. **Testing**:
   - Controller unit tests
   - API type validation tests
   - Integration tests
   - Complete E2E test suite
   - Performance testing

5. **Validation**:
   ```bash
   # Measure size
   $PROJECT_ROOT/tools/line-counter.sh
   
   # Run all tests
   go test ./...
   
   # Run E2E tests
   go test ./tests/e2e/...
   
   # Final build
   make build
   
   # Verify complete functionality
   ./idpbuilder-cert-extractor extract --cluster kind-cluster
   ```

## Size Management
- **Target Size**: 620 lines (excluding generated/tests)
- **Hard Limit**: 800 lines
- **Measurement**: Use ${PROJECT_ROOT}/tools/line-counter.sh
- **Excluded**: Generated code, test files, docs

## Feature Flags
- `CONTROLLERS_ENABLED`: Enable controller functionality
- `GITEA_INTEGRATION_ENABLED`: Enable Gitea features
- Individual controller flags as needed

## Quality Requirements
- Complete controller implementation
- No stub implementations (R320)
- Test coverage >80%
- E2E tests passing
- Performance within targets
- Documentation complete

## Integration Points
This split completes the integration:
- Controllers orchestrate all functionality
- API types define resource structure
- E2E tests validate complete system
- Final deliverable binary

## Success Criteria
- ✅ All controllers fully implemented
- ✅ API types complete and validated
- ✅ E2E tests comprehensive and passing
- ✅ Size under 700 lines (non-generated)
- ✅ No stub implementations
- ✅ Final binary fully functional
- ✅ Complete integration of all splits
- ✅ Documentation and CI/CD complete

## Final Deliverable
This split completes the kind-cert-extraction effort:
- Fully functional certificate extraction tool
- Kubernetes controllers for automation
- CLI for manual operations
- Complete test coverage
- Production-ready implementation