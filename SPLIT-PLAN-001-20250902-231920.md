# SPLIT-PLAN-001: Transport Layer and Testing

## Split 001 of 2: Transport, Utilities, and Comprehensive Testing
**Planner**: Code Reviewer code-reviewer (same for ALL splits)
**Parent Effort**: gitea-registry-client

<!-- ⚠️ ORCHESTRATOR METADATA PLACEHOLDER - DO NOT REMOVE ⚠️ -->
<!-- The orchestrator will add infrastructure metadata below: -->
<!-- WORKING_DIRECTORY, BRANCH, REMOTE, BASE_BRANCH, etc. -->
<!-- SW Engineers MUST read this metadata to navigate to the correct directory -->
<!-- END PLACEHOLDER -->

## Boundaries (⚠️⚠️⚠️ CRITICAL: All splits MUST reference SAME effort!)
- **Previous Split**: Main effort of phase2/wave1/gitea-registry-client
  - Path: efforts/phase2/wave1/gitea-registry-client/
  - Branch: idpbuilder-oci-go-cr/phase2/wave1/gitea-registry-client
  - Summary: Core client implementation (trimmed to ~750 lines)
- **This Split**: Split 001 of phase2/wave1/gitea-registry-client
  - Path: efforts/phase2/wave1/gitea-registry-client/split-001/
  - Branch: idpbuilder-oci-go-cr/phase2/wave1/gitea-registry-client-split-001
- **Next Split**: None (final split)

⚠️ NEVER reference splits from different efforts!
✅ RIGHT: All references are to phase2/wave1/gitea-registry-client

## Files in This Split (EXCLUSIVE - no overlap with main effort)

### 1. pkg/registry/transport.go (195 lines)
**Full Implementation** (moved from main effort):
```go
package registry

import (
    "crypto/tls"
    "net/http"
    "time"
    // Phase 1 integration
    "github.com/cnoe-io/idpbuilder/pkg/certs"
)

// Complete transport configuration with Phase 1 certificate integration
// - Secure transport with TrustStoreManager
// - Insecure transport with feature flags (R307)
// - Retry mechanisms
// - Timeout configurations
```

### 2. pkg/registry/helpers.go (~80 lines)
**New File** - Helper utilities extracted from main:
- Retry logic helper (from gitea_client.go)
- Extended error formatting
- Progress reporting utilities
- Platform detection helpers

### 3. pkg/registry/validation.go (~50 lines)
**New File** - Extended validation from options.go:
- Comprehensive option validation
- URL validation
- Credential validation
- Configuration sanity checks

### 4. pkg/registry/client_test.go (~50 lines)
**New File** - Unit tests for client interface:
- Test client creation
- Test option handling
- Test error types
- Test interface compliance

### 5. pkg/registry/gitea_client_test.go (~80 lines)
**New File** - Unit tests for Gitea implementation:
- Test Push/Pull operations
- Test authentication
- Test retry mechanisms
- Test feature flags (R307)
- Mock registry interactions

### 6. pkg/registry/auth_test.go (~40 lines)
**New File** - Authentication tests:
- Test basic auth
- Test anonymous auth
- Test credential validation
- Test environment variable handling

### 7. pkg/registry/transport_test.go (~60 lines)
**New File** - Transport configuration tests:
- Test secure transport with Phase 1 certs
- Test insecure mode with feature flags
- Test timeout configurations
- Test TrustStoreManager integration

### 8. go.mod and go.sum (~40 lines)
**Initialize Go Module**:
```go
module github.com/cnoe-io/idpbuilder

go 1.22

require (
    github.com/google/go-containerregistry v0.20.2
    github.com/sirupsen/logrus v1.9.3
    // Other dependencies from Phase 1
)
```

## Total Size Estimate
- transport.go: 195 lines
- helpers.go: 80 lines
- validation.go: 50 lines
- client_test.go: 50 lines
- gitea_client_test.go: 80 lines
- auth_test.go: 40 lines
- transport_test.go: 60 lines
- go.mod/go.sum: 40 lines
- **TOTAL**: ~595 lines (well under 800 limit)

## Dependencies
- Main effort must be completed and trimmed first
- Requires Phase 1 certificate infrastructure
- Uses go-containerregistry library

## Implementation Instructions

### Step 1: Create Split Infrastructure
```bash
# Orchestrator creates split directory and branch
mkdir -p efforts/phase2/wave1/gitea-registry-client/split-001
cd efforts/phase2/wave1/gitea-registry-client/split-001
git checkout -b idpbuilder-oci-go-cr/phase2/wave1/gitea-registry-client-split-001
```

### Step 2: Copy transport.go from main
```bash
# Copy the transport file that was removed from main
cp ../pkg/registry/transport.go.backup pkg/registry/transport.go
```

### Step 3: Create Helper Files
1. Create `pkg/registry/helpers.go`:
   - Extract retry logic from main effort's gitea_client.go
   - Add progress reporting utilities
   - Add platform detection helpers

2. Create `pkg/registry/validation.go`:
   - Extract validation logic from main effort's options.go
   - Add comprehensive validation functions

### Step 4: Implement Comprehensive Tests
1. Create test files for each component
2. Ensure >80% code coverage
3. Use mocks for external dependencies
4. Test Phase 1 integration thoroughly

### Step 5: Initialize Go Module
```bash
go mod init github.com/cnoe-io/idpbuilder
go mod tidy
```

### Step 6: Verify Size and Compilation
```bash
# Measure size
$PROJECT_ROOT/tools/line-counter.sh -b idpbuilder-oci-go-cr/phase2/wave1/gitea-registry-client -c $(git branch --show-current)

# Verify compilation
go build ./...
go test ./...
```

## Success Criteria
- ✅ Size under 800 lines
- ✅ All tests passing
- ✅ >80% code coverage
- ✅ Phase 1 integration verified
- ✅ Feature flags tested (R307)
- ✅ Compiles independently

## Integration Plan
After both main effort trimming and split-001 are complete:
1. Main effort provides core functionality
2. Split-001 adds transport and testing
3. Both branches merge to phase2/wave1 integration
4. Complete registry client available with all features

## Risk Mitigation
- **Test Coverage**: Comprehensive tests ensure no regression
- **Phase 1 Integration**: Thoroughly test certificate handling
- **Feature Flags**: Verify R307 compliance in tests
- **Size Management**: Conservative estimates leave buffer room