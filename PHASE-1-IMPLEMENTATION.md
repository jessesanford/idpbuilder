# PHASE 1 IMPLEMENTATION PLAN - FOUNDATION & COMMAND STRUCTURE

**Generated by**: Code Reviewer Agent
**Date**: 2025-09-22
**Project**: idpbuilder-push
**Phase**: 1 - Foundation & Command Structure
**TDD Required**: YES - Tests MUST be written FIRST

## Executive Summary

Phase 1 establishes the foundation for the `idpbuilder push` command following strict TDD methodology. This phase focuses on command registration, flag handling, input validation, and error handling patterns. Every effort MUST write tests first (RED phase) before any implementation.

**Total Phase Size**: ~800 lines
**Total Efforts**: 5 efforts across 2 waves
**Duration**: 2-3 days
**Parallelization**: Wave 1.1 must be sequential, Wave 1.2 can parallelize after Wave 1.1

## Wave 1.1: Command Skeleton with TDD

### Overview
- **Total Size**: ~500 lines
- **Parallelizable**: No (foundational - efforts must be sequential)
- **Duration**: 1-2 days
- **Integration Branch**: `idpbuilderpush/phase1/wave1/integration`

### Effort 1.1.1: Write Command Tests

**Branch**: `idpbuilderpush/phase1/wave1/command-tests`
**Size**: 150 lines
**Can Parallelize**: No (first effort, foundational)
**Parallel With**: None
**Dependencies**: None

#### Implementation Details

**Files to Create**:
- `cmd/push/root_test.go` (150 lines)

**Test Coverage Requirements**:
```go
// RED PHASE - Write these tests FIRST:
// 1. Command registration with parent command
func TestPushCommandRegistration(t *testing.T) {
    // Test that push command is registered under root
}

// 2. Flag definitions
func TestPushCommandFlags(t *testing.T) {
    // Test --username, --password, --insecure flags exist
}

// 3. Required arguments validation
func TestPushCommandArgValidation(t *testing.T) {
    // Test exactly 2 args required (image, registry)
}

// 4. Help text and usage
func TestPushCommandHelp(t *testing.T) {
    // Test help text is comprehensive
}

// 5. Flag shorthand support
func TestPushCommandFlagShorthands(t *testing.T) {
    // Test -u for --username, -p for --password, -k for --insecure
}

// 6. Environment variable support
func TestPushCommandEnvVariables(t *testing.T) {
    // Test IDPBUILDER_USERNAME, IDPBUILDER_PASSWORD env vars
}

// 7. Default value behavior
func TestPushCommandDefaults(t *testing.T) {
    // Test default values for optional flags
}
```

**Interfaces to Define (Test-Driven)**:
```go
// PushCommand interface (define through tests)
type PushCommand interface {
    Execute(args []string) error
    ValidateArgs() error
    ParseFlags() (*PushConfig, error)
}

// PushConfig structure (test-driven)
type PushConfig struct {
    Image      string
    Registry   string
    Username   string
    Password   string
    Insecure   bool
}
```

#### EXPLICIT SCOPE (R311 MANDATORY)

**IMPLEMENT EXACTLY**:
- Function: `TestPushCommandRegistration()` (~20 lines)
- Function: `TestPushCommandFlags()` (~25 lines)
- Function: `TestPushCommandArgValidation()` (~20 lines)
- Function: `TestPushCommandHelp()` (~15 lines)
- Function: `TestPushCommandFlagShorthands()` (~20 lines)
- Function: `TestPushCommandEnvVariables()` (~25 lines)
- Function: `TestPushCommandDefaults()` (~15 lines)
- Type: `PushConfig` struct (~10 lines)
**TOTAL**: ~150 lines

**DO NOT IMPLEMENT**:
- ❌ Actual command implementation (next effort)
- ❌ Integration with registry
- ❌ Authentication logic
- ❌ OCI operations
- ❌ Complex validation beyond arg count
- ❌ Logging infrastructure

---

### Effort 1.1.2: Implement Command Skeleton

**Branch**: `idpbuilderpush/phase1/wave1/command-skeleton`
**Size**: 200 lines
**Can Parallelize**: No (depends on tests)
**Parallel With**: None
**Dependencies**: Effort 1.1.1

#### Implementation Details

**Files to Create**:
- `cmd/push/root.go` (150 lines)
- `cmd/push/config.go` (50 lines)

**Minimal Implementation to Pass Tests**:
```go
// root.go - GREEN PHASE implementation
package push

import (
    "github.com/spf13/cobra"
)

var pushCmd = &cobra.Command{
    Use:   "push IMAGE REGISTRY",
    Short: "Push OCI image to Gitea registry",
    Long:  `Push an OCI image to the configured Gitea registry...`,
    Args:  cobra.ExactArgs(2),
    RunE:  runPush,
}

func init() {
    pushCmd.Flags().StringP("username", "u", "", "Registry username")
    pushCmd.Flags().StringP("password", "p", "", "Registry password")
    pushCmd.Flags().BoolP("insecure", "k", false, "Skip TLS verification")
}

func runPush(cmd *cobra.Command, args []string) error {
    // Minimal implementation to pass tests
    config, err := parseFlags(cmd, args)
    if err != nil {
        return err
    }
    return validateArgs(config)
}
```

```go
// config.go
package push

type PushConfig struct {
    Image      string
    Registry   string
    Username   string
    Password   string
    Insecure   bool
}

func parseFlags(cmd *cobra.Command, args []string) (*PushConfig, error) {
    // Parse and return config
}

func validateArgs(config *PushConfig) error {
    // Basic validation
}
```

#### EXPLICIT SCOPE (R311 MANDATORY)

**IMPLEMENT EXACTLY**:
- Variable: `pushCmd` definition (~20 lines)
- Function: `init()` with flag definitions (~15 lines)
- Function: `runPush()` minimal stub (~25 lines)
- Function: `parseFlags()` (~40 lines)
- Function: `validateArgs()` basic validation (~30 lines)
- Type: `PushConfig` struct definition (~10 lines)
- Function: `NewPushCommand()` factory (~30 lines)
- Function: `GetCommand()` getter (~10 lines)
- Constants: Error messages (~20 lines)
**TOTAL**: ~200 lines

**DO NOT IMPLEMENT**:
- ❌ Registry client creation
- ❌ Authentication handling
- ❌ OCI push operations
- ❌ Complex error handling
- ❌ Logging beyond basic errors
- ❌ Credential retrieval from secrets
- ❌ Transport configuration

---

### Effort 1.1.3: Integration Tests

**Branch**: `idpbuilderpush/phase1/wave1/integration-tests`
**Size**: 150 lines
**Can Parallelize**: No (depends on implementation)
**Parallel With**: None
**Dependencies**: Effort 1.1.2

#### Implementation Details

**Files to Create**:
- `cmd/push/integration_test.go` (150 lines)

**Test Scenarios**:
```go
// RED-GREEN cycle for integration
// 1. Full command execution flow
func TestPushCommandIntegration(t *testing.T) {
    // Test end-to-end command execution
}

// 2. Flag precedence (CLI > ENV > defaults)
func TestFlagPrecedence(t *testing.T) {
    // Test flag override behavior
}

// 3. Error propagation and messages
func TestErrorPropagation(t *testing.T) {
    // Test error handling through full stack
}

// 4. Help text generation
func TestHelpTextGeneration(t *testing.T) {
    // Test help output formatting
}

// 5. Command discovery in CLI
func TestCommandDiscovery(t *testing.T) {
    // Test command appears in idpbuilder help
}

// 6. Subcommand interaction
func TestSubcommandInteraction(t *testing.T) {
    // Test with parent command context
}
```

#### EXPLICIT SCOPE (R311 MANDATORY)

**IMPLEMENT EXACTLY**:
- Function: `TestPushCommandIntegration()` (~30 lines)
- Function: `TestFlagPrecedence()` (~25 lines)
- Function: `TestErrorPropagation()` (~25 lines)
- Function: `TestHelpTextGeneration()` (~20 lines)
- Function: `TestCommandDiscovery()` (~25 lines)
- Function: `TestSubcommandInteraction()` (~25 lines)
**TOTAL**: ~150 lines

**DO NOT IMPLEMENT**:
- ❌ E2E tests with real registry
- ❌ Performance tests
- ❌ Load tests
- ❌ Security tests
- ❌ Cross-platform tests

---

## Wave 1.2: Input Validation & Error Handling

### Overview
- **Total Size**: ~300 lines
- **Parallelizable**: Yes (after Wave 1.1 completes)
- **Duration**: 1 day
- **Integration Branch**: `idpbuilderpush/phase1/wave2/integration`

### Effort 1.2.1: Validation Tests

**Branch**: `idpbuilderpush/phase1/wave2/validation-tests`
**Size**: 150 lines
**Can Parallelize**: Yes (after Wave 1.1)
**Parallel With**: None (can start alone after Wave 1.1)
**Dependencies**: Wave 1.1 completion

#### Implementation Details

**Files to Create**:
- `pkg/oci/validation_test.go` (150 lines)

**Test Coverage (RED PHASE)**:
```go
// Validation scenarios to test FIRST
// 1. Image path formats
func TestValidateImagePath(t *testing.T) {
    // Test local files, directories, tar archives
}

// 2. Registry URL validation
func TestValidateRegistryURL(t *testing.T) {
    // Test https://gitea.cnoe.localtest.me format
}

// 3. Credential validation
func TestValidateCredentials(t *testing.T) {
    // Test username/password requirements
}

// 4. Special character handling
func TestSpecialCharacterHandling(t *testing.T) {
    // Test input sanitization
}

// 5. Path traversal prevention
func TestPathTraversalPrevention(t *testing.T) {
    // Test security validations
}

// 6. Size limit checks
func TestSizeLimitChecks(t *testing.T) {
    // Test file size validations
}

// 7. Malformed input rejection
func TestMalformedInputRejection(t *testing.T) {
    // Test invalid format handling
}
```

**Validation Interface (test-driven)**:
```go
type Validator interface {
    ValidateImagePath(path string) error
    ValidateRegistryURL(url string) error
    ValidateCredentials(username, password string) error
    SanitizeInput(input string) string
}
```

#### EXPLICIT SCOPE (R311 MANDATORY)

**IMPLEMENT EXACTLY**:
- Function: `TestValidateImagePath()` (~25 lines)
- Function: `TestValidateRegistryURL()` (~25 lines)
- Function: `TestValidateCredentials()` (~20 lines)
- Function: `TestSpecialCharacterHandling()` (~20 lines)
- Function: `TestPathTraversalPrevention()` (~20 lines)
- Function: `TestSizeLimitChecks()` (~20 lines)
- Function: `TestMalformedInputRejection()` (~20 lines)
**TOTAL**: ~150 lines

**DO NOT IMPLEMENT**:
- ❌ Actual validation implementation (next effort)
- ❌ Complex regex patterns
- ❌ External validation services
- ❌ Database validation
- ❌ Network validation calls

---

### Effort 1.2.2: Implement Validation

**Branch**: `idpbuilderpush/phase1/wave2/validation-impl`
**Size**: 150 lines
**Can Parallelize**: No (depends on validation tests)
**Parallel With**: None
**Dependencies**: Effort 1.2.1

#### Implementation Details

**Files to Create**:
- `pkg/oci/validation.go` (100 lines)
- `pkg/oci/errors.go` (50 lines)

**Implementation (GREEN-REFACTOR PHASE)**:
```go
// validation.go
package oci

import (
    "fmt"
    "net/url"
    "path/filepath"
    "strings"
)

// ValidationError provides detailed validation failure info
type ValidationError struct {
    Field   string
    Value   string
    Message string
    Code    string
}

// ValidateImagePath checks if image path is valid
func ValidateImagePath(path string) error {
    // Minimal implementation to pass tests
    if path == "" {
        return &ValidationError{
            Field:   "image",
            Value:   path,
            Message: "image path cannot be empty",
            Code:    "EMPTY_PATH",
        }
    }
    // Additional validations
    return nil
}

// ValidateRegistryURL verifies registry URL format
func ValidateRegistryURL(url string) error {
    // Validate URL format
}

// ValidateCredentials checks credential format
func ValidateCredentials(username, password string) error {
    // Basic credential validation
}

// SanitizeInput removes dangerous characters
func SanitizeInput(input string) string {
    // Input sanitization
}
```

```go
// errors.go
package oci

const (
    ErrCodeEmptyPath    = "EMPTY_PATH"
    ErrCodeInvalidURL   = "INVALID_URL"
    ErrCodeInvalidCreds = "INVALID_CREDS"
    // Other error codes
)

func (e *ValidationError) Error() string {
    return fmt.Sprintf("%s: %s", e.Field, e.Message)
}
```

#### EXPLICIT SCOPE (R311 MANDATORY)

**IMPLEMENT EXACTLY**:
- Type: `ValidationError` struct (~15 lines)
- Function: `ValidateImagePath()` (~25 lines)
- Function: `ValidateRegistryURL()` (~25 lines)
- Function: `ValidateCredentials()` (~20 lines)
- Function: `SanitizeInput()` (~15 lines)
- Function: `(e *ValidationError) Error()` (~10 lines)
- Constants: Error codes (~20 lines)
- Helper: `isValidPath()` internal (~10 lines)
- Helper: `isValidURL()` internal (~10 lines)
**TOTAL**: ~150 lines

**DO NOT IMPLEMENT**:
- ❌ Complex regex validation
- ❌ External URL verification
- ❌ File system checks
- ❌ Network connectivity tests
- ❌ Certificate validation
- ❌ Advanced sanitization

---

## Integration Strategy

### Wave 1.1 Integration
After all Wave 1.1 efforts complete:
1. Merge efforts sequentially to `idpbuilderpush/phase1/wave1/integration`
2. Run full test suite
3. Verify 100% test coverage
4. Create integration tag

### Wave 1.2 Integration
After all Wave 1.2 efforts complete:
1. Merge efforts to `idpbuilderpush/phase1/wave2/integration`
2. Merge Wave 1.1 integration into Wave 1.2
3. Run full test suite
4. Verify 100% test coverage

### Phase 1 Integration
After both waves complete:
1. Merge Wave 1.2 integration to `idpbuilderpush/phase1/integration`
2. Full phase testing
3. Architect review
4. Documentation update

## TDD Compliance Verification

### Commit Order Requirements
Each effort MUST show:
1. **First Commit**: Test files only (RED phase)
2. **Second Commit**: Minimal implementation (GREEN phase)
3. **Third Commit**: Refactoring (REFACTOR phase)

### Coverage Tracking
- Wave 1.1 Target: 100% coverage
- Wave 1.2 Target: 100% coverage
- Phase 1 Overall: 100% coverage

### Evidence Collection
- Git log must show test-first commits
- Coverage reports for each effort
- Test execution logs

## Dependencies and Constraints

### External Dependencies
- `github.com/spf13/cobra` - CLI framework (existing)
- `github.com/stretchr/testify` - Test assertions
- Standard library only for Phase 1

### Constraints
- **800 line limit** per effort (HARD LIMIT)
- **Test-first** development (MANDATORY)
- **100% coverage** target (REQUIRED)
- **No stub implementations** (R355 compliance)
- **No code deletion** to meet size limits (R359 compliance)

## Success Metrics

### Functional Success
- [ ] Push command appears in `idpbuilder --help`
- [ ] All flags parse correctly
- [ ] Validation rejects invalid inputs
- [ ] Clear error messages displayed
- [ ] Tests written before implementation

### Quality Metrics
- [ ] 100% test coverage achieved
- [ ] All tests passing
- [ ] Zero linting errors
- [ ] TDD evidence in commit history
- [ ] No stub implementations

### Timeline
- **Wave 1.1**: Days 1-2 (Sequential efforts)
- **Wave 1.2**: Day 2-3 (Can parallelize after Wave 1.1)
- **Integration**: Day 3
- **Buffer**: Half day for review/fixes

## Risk Mitigation

### Technical Risks
1. **Command Registration Conflicts**
   - Check existing commands first
   - Test with full idpbuilder CLI

2. **Flag Naming Collisions**
   - Use standard conventions
   - Align with existing flags

3. **Test Coverage Gaps**
   - Write tests FIRST always
   - Run coverage after each commit

## Phase 1 Deliverables Summary

### Wave 1.1 Files
- `cmd/push/root_test.go` (150 LOC) - Tests FIRST
- `cmd/push/root.go` (150 LOC) - Implementation
- `cmd/push/config.go` (50 LOC) - Config structures
- `cmd/push/integration_test.go` (150 LOC) - Integration tests

### Wave 1.2 Files
- `pkg/oci/validation_test.go` (150 LOC) - Tests FIRST
- `pkg/oci/validation.go` (100 LOC) - Implementation
- `pkg/oci/errors.go` (50 LOC) - Error types

### Total Phase 1
- **Files**: 7
- **Lines**: ~800
- **Test Files**: 3 (written first)
- **Implementation Files**: 4 (written to pass tests)

## Notes for Software Engineers

### CRITICAL TDD REQUIREMENTS
1. **ALWAYS** write tests first - no exceptions
2. **COMMIT** tests before writing any implementation
3. **RUN** tests to see them fail (RED phase)
4. **WRITE** minimal code to pass (GREEN phase)
5. **REFACTOR** only after tests pass

### Size Management
- Check line count frequently
- Use `$PROJECT_ROOT/tools/line-counter.sh` ONLY
- Stop immediately if approaching 800 lines
- Never delete code to meet limits

### Quality Standards
- 100% test coverage required
- Clear commit messages showing TDD cycle
- No TODOs or stubs in code
- All functions must be implemented

---

*This implementation plan is derived from the Architect's Phase 1 Architecture. All efforts must follow TDD methodology with tests written FIRST.*