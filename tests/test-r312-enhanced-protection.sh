#!/bin/bash

# Test script for R312 Enhanced Protection with root ownership
# This verifies that git config gets DOUBLE protection (root:root + 444)

set -e

echo "üß™ R312 Enhanced Protection Test Suite"
echo "======================================"
echo ""

# Test directory
TEST_DIR="/tmp/r312-test-$$"
mkdir -p "$TEST_DIR"
cd "$TEST_DIR"

# Initialize git repo
git init
git config user.name "Test User"
git config user.email "test@example.com"

echo "üìã Initial state:"
echo "   Owner: $(stat -c %U:%G .git/config 2>/dev/null || stat -f %Su:%Sg .git/config)"
echo "   Permissions: $(stat -c %a .git/config 2>/dev/null || stat -f %A .git/config)"
echo ""

# Test 1: Apply full protection with sudo
echo "üß™ Test 1: Full protection with sudo"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
if command -v sudo >/dev/null 2>&1; then
    echo "‚úÖ sudo available - testing FULL protection"
    
    # Apply protection
    sudo chown root:root .git/config
    sudo chmod 444 .git/config
    
    # Verify ownership
    OWNER=$(stat -c %U:%G .git/config 2>/dev/null || stat -f %Su:%Sg .git/config)
    PERMS=$(stat -c %a .git/config 2>/dev/null || stat -f %A .git/config)
    
    echo "üìã After protection:"
    echo "   Owner: $OWNER"
    echo "   Permissions: $PERMS"
    
    if [ "$OWNER" = "root:root" ] && [ "$PERMS" = "444" ]; then
        echo "‚úÖ FULL protection applied successfully"
    else
        echo "‚ùå Failed to apply full protection"
        exit 1
    fi
    
    # Test bypass attempts
    echo ""
    echo "üß™ Testing bypass attempts:"
    
    # Try to make it writable without sudo (should fail)
    if chmod 644 .git/config 2>/dev/null; then
        echo "‚ùå CRITICAL: Non-owner could change permissions!"
        exit 1
    else
        echo "‚úÖ chmod without sudo correctly blocked"
    fi
    
    # Try to write to it (should fail)
    if echo "test" >> .git/config 2>/dev/null; then
        echo "‚ùå CRITICAL: Could write to readonly config!"
        exit 1
    else
        echo "‚úÖ Write attempt correctly blocked"
    fi
    
    # Try git config modification
    # Note: git creates a new file and renames, so it may succeed even with protection
    # This is why we need BOTH the protection AND SW engineer discipline
    if git config user.name "Hacker" 2>/dev/null; then
        echo "‚ö†Ô∏è Git can still modify (creates new file) - SW discipline required"
        # Reset it back
        sudo chown root:root .git/config
        sudo chmod 444 .git/config
    else
        echo "‚úÖ Git config modification blocked on this system"
    fi
    
    # Test unlock for integration
    echo ""
    echo "üß™ Testing unlock for integration:"
    sudo chown $(id -u):$(id -g) .git/config
    sudo chmod 644 .git/config
    
    if [ -w .git/config ]; then
        echo "‚úÖ Successfully unlocked for integration"
    else
        echo "‚ùå Failed to unlock config"
        exit 1
    fi
    
else
    echo "‚ö†Ô∏è sudo not available - testing PARTIAL protection only"
    
    # Apply permission-only protection
    chmod 444 .git/config
    
    PERMS=$(stat -c %a .git/config 2>/dev/null || stat -f %A .git/config)
    echo "üìã After protection:"
    echo "   Permissions: $PERMS"
    
    if [ "$PERMS" = "444" ]; then
        echo "‚úÖ PARTIAL protection applied (permissions only)"
    else
        echo "‚ùå Failed to apply permission protection"
        exit 1
    fi
    
    echo "‚ö†Ô∏è Note: Without sudo, protection can be bypassed with chmod"
fi

echo ""
echo "üß™ Test 2: Docker/Container scenario simulation"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# Simulate container environment (no sudo)
(
    export PATH="/usr/bin:/bin"  # Remove sudo from PATH temporarily
    
    if ! command -v sudo >/dev/null 2>&1; then
        echo "‚úÖ Simulated no-sudo environment"
        
        # Should fall back to permission-only
        chmod 644 .git/config  # Reset first
        chmod 444 .git/config  # Apply protection
        
        if [ ! -w .git/config ]; then
            echo "‚úÖ Permission-only protection works in container"
        else
            echo "‚ùå Failed to protect in container environment"
        fi
    fi
)

echo ""
echo "üß™ Test 3: Verification marker"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# Create marker file
cat > .git/R312_CONFIG_LOCKED << EOF
Timestamp: $(date '+%Y-%m-%d %H:%M:%S')
Locked by: test-script
Protection level: TEST
Purpose: Testing R312 enhanced protection
EOF

if [ -f .git/R312_CONFIG_LOCKED ]; then
    echo "‚úÖ Protection marker created successfully"
    echo "üìã Marker contents:"
    cat .git/R312_CONFIG_LOCKED | sed 's/^/   /'
else
    echo "‚ùå Failed to create marker"
    exit 1
fi

echo ""
echo "üß™ Test 4: SW Engineer validation simulation"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# Reset to protected state for validation
if command -v sudo >/dev/null 2>&1; then
    sudo chown root:root .git/config
    sudo chmod 444 .git/config
else
    chmod 444 .git/config
fi

# Simulate SW engineer validation
if [ -w .git/config ]; then
    echo "‚ùå Config is writable - validation would fail!"
    exit 1
else
    echo "‚úÖ Config is readonly - validation passes"
    
    OWNER=$(stat -c %U:%G .git/config 2>/dev/null || stat -f %Su:%Sg .git/config)
    if [ "$OWNER" = "root:root" ]; then
        echo "   üîê FULL protection detected (root-owned)"
    else
        echo "   üîí PARTIAL protection detected (permission-only)"
    fi
fi

# Cleanup
cd /
rm -rf "$TEST_DIR"

echo ""
echo "======================================"
echo "‚úÖ ALL R312 ENHANCED PROTECTION TESTS PASSED"
echo "======================================"
echo ""
echo "Summary:"
echo "- Full protection (root:root + 444) works when sudo available"
echo "- Fallback to permission-only (444) when sudo unavailable"
echo "- Bypass attempts correctly blocked with full protection"
echo "- Unlock for integration works correctly"
echo "- SW engineer validation detects protection level"
echo "- Protection markers created successfully"