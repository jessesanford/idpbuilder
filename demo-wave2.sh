#!/bin/bash
# Wave 2 Integration Demo Script (R291/R330)
echo "üé¨ Running Phase 1 Wave 2 Integration Demo..."
echo "=============================================="
echo "This demo validates all Wave 2 components are properly integrated"
echo ""

DEMO_DIR="$(pwd)/demo-results"
FAILED=false

echo "üìÅ Demo results directory: $DEMO_DIR"
echo ""

# Run each individual demo
echo "1. Certificate Validation Demo..."
if ./demo-cert-validation.sh > /dev/null 2>&1; then
    echo "   ‚úÖ cert-validation demo PASSED"
else
    echo "   ‚ùå cert-validation demo FAILED"
    FAILED=true
fi

echo "2. Chain Validation Demo..."
if ./demo-chain-validation.sh > /dev/null 2>&1; then
    echo "   ‚úÖ chain-validation demo PASSED"
else
    echo "   ‚ùå chain-validation demo FAILED"
    FAILED=true
fi

echo "3. Fallback Strategies Demo..."
if ./demo-fallback.sh > /dev/null 2>&1; then
    echo "   ‚úÖ fallback-strategies demo PASSED"
else
    echo "   ‚ùå fallback-strategies demo FAILED"
    FAILED=true
fi

echo "4. Validators Demo..."
if ./demo-validators.sh > /dev/null 2>&1; then
    echo "   ‚úÖ validators demo PASSED"
else
    echo "   ‚ùå validators demo FAILED"
    FAILED=true
fi

echo ""
echo "=============================================="

# Verify integration points
echo "üîç Verifying Integration Points..."
echo ""

# Check for cert validation package
if [ -d "pkg/certvalidation" ]; then
    echo "‚úÖ Certificate validation package integrated"
else
    echo "‚ùå Certificate validation package missing"
    FAILED=true
fi

# Check for fallback package
if [ -d "pkg/fallback" ]; then
    echo "‚úÖ Fallback strategies package integrated"
else
    echo "‚ùå Fallback strategies package missing"
    FAILED=true
fi

# Check for insecure package
if [ -d "pkg/insecure" ]; then
    echo "‚úÖ Insecure mode package integrated"
else
    echo "‚ùå Insecure mode package missing"
    FAILED=true
fi

# Check build passes
echo ""
echo "üî® Verifying build..."
if go build ./... > /dev/null 2>&1; then
    echo "‚úÖ All packages build successfully"
else
    echo "‚ùå Build failed"
    FAILED=true
fi

# Check tests pass
echo ""
echo "üß™ Verifying tests..."
TEST_OUTPUT=$(go test ./pkg/certs ./pkg/certvalidation ./pkg/fallback ./pkg/insecure 2>&1)
if echo "$TEST_OUTPUT" | grep -q "^FAIL"; then
    echo "‚ùå Some tests failed"
    FAILED=true
else
    echo "‚úÖ All integrated package tests pass"
fi

echo ""
echo "=============================================="
if [ "$FAILED" = "true" ]; then
    echo "‚ùå WAVE 2 INTEGRATION DEMO FAILED"
    echo ""
    echo "Please review the individual demo logs in $DEMO_DIR"
    exit 1
else
    echo "‚úÖ WAVE 2 INTEGRATION DEMO COMPLETED SUCCESSFULLY!"
    echo ""
    echo "Summary:"
    echo "  ‚Ä¢ All effort demos executed successfully"
    echo "  ‚Ä¢ All packages integrated properly"
    echo "  ‚Ä¢ Build compiles successfully"
    echo "  ‚Ä¢ Tests pass for integrated components"
    echo ""
    echo "The Phase 1 Wave 2 integration is ready for:"
    echo "  ‚Ä¢ Push to remote repository"
    echo "  ‚Ä¢ Architect review"
    echo "  ‚Ä¢ Merge to main branch"
fi