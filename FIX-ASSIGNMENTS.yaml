# FIX ASSIGNMENTS - R291 BUILD GATE FAILURE
# Generated by Code Reviewer Agent
# Date: 2025-09-11
# Status: CRITICAL - Immediate Action Required

metadata:
  issue: "Duplicate TLSConfig struct causing compilation failure"
  severity: "CRITICAL"
  rule: "R291 - BUILD GATE FAILURE"
  compliance: "R300 - All fixes to effort branches"

fix_assignments:
  # Phase 1: Owner of TLSConfig (MUST BE FIXED FIRST)
  registry_auth_types_split_002:
    branch: "idpbuilder-oci-build-push/phase1/wave1/registry-auth-types-split-002"
    working_directory: "efforts/phase1/wave1/registry-auth-types-split-002"
    priority: 1  # Must be fixed first
    assignee: "SW Engineer - registry-auth-types effort"
    
    tasks:
      - task_id: "SPLIT002-FIX-001"
        description: "Consolidate TLSConfig struct with all required fields"
        file: "pkg/certs/types.go"
        action: "ADD_FIELDS"
        details: |
          Add these fields to existing TLSConfig struct:
          - Registry string
          - ValidateHostname bool  
          - Timeout time.Duration
        
      - task_id: "SPLIT002-FIX-002"
        description: "Add DefaultTLSConfig constructor"
        file: "pkg/certs/types.go"
        action: "ADD_FUNCTION"
        code: |
          func DefaultTLSConfig() *TLSConfig {
              return &TLSConfig{
                  MinVersion:       tls.VersionTLS12,
                  ValidateHostname: true,
                  Timeout:          10 * time.Second,
              }
          }
      
      - task_id: "SPLIT002-FIX-003"
        description: "Export test helper functions"
        file: "pkg/certs/test_helpers.go"
        action: "CREATE_FILE"
        details: |
          Create new file with exported test helpers:
          - CreateTestCertificate(t *testing.T)
          - CreateExpiredTestCertificate(t *testing.T)
          
      - task_id: "SPLIT002-FIX-004"
        description: "Update test files to use exported helpers"
        file: "pkg/certs/types_test.go"
        action: "UPDATE_IMPORTS"
        
      - task_id: "SPLIT002-FIX-005"
        description: "Test and commit changes"
        action: "VERIFY_AND_COMMIT"
        commands:
          - "go build ./..."
          - "go test ./..."
          - "git add -A"
          - "git commit -m 'fix: consolidate TLSConfig and export test helpers for integration'"
          - "git push"
    
    verification:
      - "TLSConfig compiles with all fields"
      - "No duplicate declarations"
      - "Tests pass"
      - "Exports are accessible to other packages"

  # Phase 2: Consumer of TLSConfig (FIX AFTER SPLIT-002)
  registry_tls_trust:
    branch: "idpbuilder-oci-build-push/phase1/wave1/registry-tls-trust"
    working_directory: "efforts/phase1/wave1/registry-tls-trust"
    priority: 2  # Fix after split-002
    assignee: "SW Engineer - registry-tls-trust effort"
    depends_on: ["registry_auth_types_split_002"]
    
    tasks:
      - task_id: "TRUST-FIX-001"
        description: "Remove duplicate TLSConfig struct"
        file: "pkg/certs/utilities.go"
        action: "REMOVE_LINES"
        lines: "130-136"
        
      - task_id: "TRUST-FIX-002"
        description: "Remove DefaultTLSConfig function"
        file: "pkg/certs/utilities.go"
        action: "REMOVE_LINES"
        lines: "139-145"
        
      - task_id: "TRUST-FIX-003"
        description: "Import types from split-002"
        file: "pkg/certs/utilities.go"
        action: "ADD_IMPORT"
        import: 'certtypes "github.com/cnoe-io/idpbuilder/pkg/certs"'
        
      - task_id: "TRUST-FIX-004"
        description: "Update all TLSConfig references"
        file: "pkg/certs/utilities.go"
        action: "REPLACE_ALL"
        from: "TLSConfig"
        to: "certtypes.TLSConfig"
        
      - task_id: "TRUST-FIX-005"
        description: "Convert LoadConfigFromEnv to package function"
        file: "pkg/certs/utilities.go"
        action: "UPDATE_FUNCTION"
        details: |
          Change from method to function:
          func LoadTLSConfigFromEnv(c *certtypes.TLSConfig)
          
      - task_id: "TRUST-FIX-006"
        description: "Remove duplicate test helpers"
        files:
          - "pkg/certs/trust_test.go"
          - "pkg/certs/utilities_test.go"
        action: "REMOVE_DUPLICATES"
        functions:
          - "createTestCertificate"
          - "createExpiredTestCertificate"
          
      - task_id: "TRUST-FIX-007"
        description: "Test and commit changes"
        action: "VERIFY_AND_COMMIT"
        commands:
          - "go build ./..."
          - "go test ./..."
          - "git add -A"
          - "git commit -m 'fix: remove duplicate TLSConfig, import from registry-auth-types'"
          - "git push"
    
    verification:
      - "No duplicate TLSConfig declaration"
      - "Imports certtypes correctly"
      - "All references updated"
      - "Tests pass with imported types"

timeline:
  estimated_duration: "2 hours"
  phases:
    - phase: 1
      duration: "1 hour"
      effort: "registry_auth_types_split_002"
      status: "Ready to start"
      
    - phase: 2
      duration: "1 hour"
      effort: "registry_tls_trust"
      status: "Blocked until Phase 1 complete"

post_fix_actions:
  - action: "Re-run integration merge"
    responsible: "Integration Agent"
    trigger: "Both effort branches fixed and pushed"
    
  - action: "Verify BUILD GATE passes"
    responsible: "Integration Agent"
    success_criteria:
      - "Compilation succeeds"
      - "All tests pass"
      - "No duplicate declarations"
      
  - action: "Update orchestrator state"
    responsible: "Orchestrator"
    new_state: "MONITORING_INTEGRATION"

notes:
  - "R300 Compliance: All fixes go to effort branches ONLY"
  - "Do NOT modify integration branch directly"
  - "Coordinate timing between engineers to minimize delays"
  - "Test locally before pushing to avoid multiple fix cycles"
  - "If additional issues found, create new fix assignments"

# Status Tracking
status:
  created_at: "2025-09-11T06:30:00Z"
  created_by: "code-reviewer"
  last_updated: "2025-09-11T06:30:00Z"
  fixes_applied:
    registry_auth_types_split_002: false
    registry_tls_trust: false
  integration_verified: false
  build_gate_passed: false