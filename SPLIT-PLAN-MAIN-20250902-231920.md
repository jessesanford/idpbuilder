# SPLIT-PLAN-MAIN: Trim Existing Implementation

## Split Main of 2: Core Gitea Registry Client (Trimmed)
**Planner**: Code Reviewer code-reviewer (same for ALL splits)
**Parent Effort**: gitea-registry-client
**Type**: TRIM EXISTING (not new implementation)

<!-- ⚠️ ORCHESTRATOR METADATA PLACEHOLDER - DO NOT REMOVE ⚠️ -->
<!-- The orchestrator will add infrastructure metadata below: -->
<!-- WORKING_DIRECTORY, BRANCH, REMOTE, BASE_BRANCH, etc. -->
<!-- SW Engineers MUST read this metadata to navigate to the correct directory -->
<!-- END PLACEHOLDER -->

## Current Status
- **Current Size**: 1151 lines (351 over limit)
- **Target Size**: ~750 lines (need to trim ~400 lines)
- **Branch**: idpbuilder-oci-go-cr/phase2/wave1/gitea-registry-client (EXISTING)
- **Action Required**: TRIM, not implement new code

## Boundaries (⚠️⚠️⚠️ CRITICAL: All splits MUST reference SAME effort!)
- **Previous Split**: None (this is the main effort)
- **This Split**: Main effort of phase2/wave1/gitea-registry-client
  - Path: efforts/phase2/wave1/gitea-registry-client/
  - Branch: idpbuilder-oci-go-cr/phase2/wave1/gitea-registry-client (EXISTING)
- **Next Split**: Split 001 of phase2/wave1/gitea-registry-client
  - Path: efforts/phase2/wave1/gitea-registry-client/split-001/
  - Branch: idpbuilder-oci-go-cr/phase2/wave1/gitea-registry-client-split-001

## Files to TRIM (NOT recreate)

### 1. pkg/registry/client.go (208 → ~150 lines)
**Trimming Actions**:
- Consolidate 5 error type structs into 1 with error codes
- Remove verbose inline comments (keep function docs)
- Combine ClientOption variations into single flexible type
- Extract progress reporting interfaces to split-001

**Keep**:
- Core Client interface
- Essential error types (consolidated)
- Basic option types

**Move to Split-001**:
- Extended error details
- Progress reporting interfaces
- Helper utilities

### 2. pkg/registry/gitea_client.go (489 → ~400 lines)
**Trimming Actions**:
- Extract retry logic helper (20 lines) to transport in split-001
- Consolidate error handling in each method (save ~30 lines)
- Remove debug logging statements (save ~20 lines)
- Simplify platform detection logic (save ~10 lines)

**Keep**:
- All core methods (Push, Pull, Catalog, Tags, Ping)
- Phase 1 certificate integration
- Feature flag support (R307 compliance)
- Essential error handling

**Move to Split-001**:
- Detailed retry mechanisms
- Extended logging
- Test helper methods

### 3. pkg/registry/auth.go (145 lines - KEEP AS IS)
**No Changes**: This file is essential and well-sized

### 4. pkg/registry/transport.go (195 lines - MOVE TO SPLIT-001)
**Action**: REMOVE ENTIRELY from main effort
- This entire file moves to split-001
- Main effort will use simplified transport initialization

### 5. pkg/registry/options.go (106 → ~50 lines)
**Trimming Actions**:
- Keep only NewDefaultOptions and basic validation
- Move detailed validation to split-001
- Simplify option structures

**Keep**:
- Default configuration
- Basic validation
- Core option fields

**Move to Split-001**:
- Extended validation
- Option cloning
- Advanced configurations

## Implementation Instructions for SW Engineer

### Step 1: Prepare for Trimming
```bash
cd efforts/phase2/wave1/gitea-registry-client
git status  # Ensure clean state
```

### Step 2: Trim client.go
1. Open pkg/registry/client.go
2. Consolidate error types:
   ```go
   // Replace 5 separate error structs with:
   type ClientError struct {
       Code    string
       Message string
       Details map[string]interface{}
   }
   ```
3. Remove verbose comments but keep function documentation
4. Simplify option types

### Step 3: Trim gitea_client.go
1. Open pkg/registry/gitea_client.go
2. Extract retry helper function (mark for split-001)
3. Consolidate error handling in each method
4. Remove debug log statements
5. Keep ALL functionality, just more concise

### Step 4: Remove transport.go
```bash
git rm pkg/registry/transport.go
# This file will be recreated in split-001
```

### Step 5: Trim options.go
1. Keep only essential functions
2. Remove extended validation
3. Simplify structures

### Step 6: Verify Size
```bash
$PROJECT_ROOT/tools/line-counter.sh -b idpbuilder-oci-go-cr/phase1-integration-20250902-194557 -c idpbuilder-oci-go-cr/phase2/wave1/gitea-registry-client
```

### Step 7: Ensure Compilation
```bash
cd pkg/registry
go build ./...  # Should still compile
```

## Expected Result
- **Final Size**: ~750 lines (under 800 limit)
- **Functionality**: All core features preserved
- **Compilation**: Still builds successfully
- **Next Step**: Implement split-001 for transport and tests

## Critical Requirements
- ✅ Maintain R307 compliance (feature flags)
- ✅ Keep Phase 1 certificate integration
- ✅ Preserve all core functionality
- ✅ Ensure independent compilation
- ✅ Document what moves to split-001

## Validation Checklist
- [ ] Main effort under 800 lines
- [ ] All core functionality preserved
- [ ] Code still compiles
- [ ] Feature flags maintained (R307)
- [ ] Phase 1 integration intact
- [ ] Clear documentation of moved components